<!DOCTYPE html>
<html lang="zh-CN">
<!-- 修复XLSX库的CDN引用 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>本地刷题</title>
    <style>
:root {
        --correct-color: #4CAF50;
        --wrong-color: #f44336;
        --primary-color: #2196F3;
        --primary-light: #64b5f6;
        --primary-dark: #1976d2;
        --light-bg: #f5f5f5;
        --header-bg: #2196F3;
        /* 将黑色改为蓝色 */
        --header-text: white;
        --card-bg: white;
        --text-color: #333;
        --border-color: #e0e0e0;
    }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background-color: var(--card-bg);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .header {
            padding: 15px;
            text-align: center;
            background-color: var(--header-bg);
            color: var(--header-text);
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .content {
            padding: 20px;
            padding-bottom: 70px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            height: 60px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        .nav-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #666;
            text-decoration: none;
            font-size: 12px;
            padding: 8px 0;
            transition: all 0.2s;
        }

        .nav-button.active {
            color: var(--primary-dark);
            background-color: rgba(33, 150, 243, 0.1);
        }

        .nav-button i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .library-manager {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .library-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .library-item {
            padding: 8px 15px;
            background-color: var(--light-bg);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: 1px solid var(--border-color);
        }

        .library-item:hover {
            background-color: #e0e0e0;
        }

        .library-item.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--light-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        .question-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .question {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
        }

        .option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            background-color: var(--light-bg);
            border: none;
            border-left: 4px solid transparent;
            border-radius: 4px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            background-color: #e0e0e0;
        }

        .option-letter {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background-color: #ddd;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }

        .correct-answer {
            background-color: #e8f5e9 !important;
            border-left-color: var(--correct-color) !important;
            color: #2e7d32;
        }

        .correct-answer .option-letter {
            background-color: var(--correct-color);
            color: white;
        }

        .wrong-answer {
            background-color: #ffebee !important;
            border-left-color: var(--wrong-color) !important;
            color: #c62828;
        }

        .wrong-answer .option-letter {
            background-color: var(--wrong-color);
            color: white;
        }

        .back-mode-option {
            background-color: white;
            cursor: default;
        }

        .answer-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid var(--correct-color);
        }

        .explanation-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--primary-dark);
        }

        .button-success {
            background-color: var(--correct-color);
            color: white;
        }

        .button-success:hover {
            background-color: #388e3c;
        }

        .button-danger {
            background-color: var(--wrong-color);
            color: white;
        }

        .button-danger:hover {
            background-color: #d32f2f;
        }

        .button-warning {
            background-color: #FF9800;
            color: white;
        }

        .button-warning:hover {
            background-color: #f57c00;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .status-info {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 60px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .selected {
            background-color: #fff3e0 !important;
            border-left: 4px solid #FF9800 !important;
        }

        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .icon-bank {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M12 2L1 8v2h22V8M5 10v7h2v-7m4 0v7h2v-7m4 0v7h2v-7m4 0v7h2v-7M1 22h22v-2H1"/></svg>');
        }

        .icon-practice {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/><path d="M7 12h2v5H7zm4-7h2v12h-2zm4 5h2v7h-2z"/></svg>');
        }

        .icon-memorize {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>');
        }

        .icon-settings {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>');
        }

        .icon-wrong {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f44336"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg>');
        }

        .icon-favorite {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FF9800"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>');
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .answer-result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .selected-option {
            background-color: #fff3e0 !important;
            border-left: 4px solid #FF9800 !important;
        }

        .selected-option .option-letter {
            background-color: #FF9800 !important;
            color: white;
        }

        .wrong-answer {
            background-color: #ffebee !important;
            border-left: 4px solid var(--wrong-color) !important;
            color: #c62828;
        }

        .wrong-answer .option-letter {
            background-color: var(--wrong-color);
            color: white;
        }

        /* 新增编辑模式样式 */
        .edit-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* 添加在.edit-container样式之后 */
        #cancelEditButton {
            width: 100%;
            padding: 10px;
            font-size: 16px;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .edit-form textarea,
        .edit-form input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .edit-form textarea {
            min-height: 60px;
            resize: vertical;
        }

        .edit-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .edit-option {
            display: flex;
            flex-direction: column;
            /* 改为垂直布局 */
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .edit-option-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .edit-option-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* 图片预览样式调整 */
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 5px;
            display: block;
        }

        .edit-option-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edit-option input[type="text"] {
            min-height: 40px;
            /* 设置最小高度 */
            min-width: 200px;
            /* 设置最小宽度 */
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: both;
            /* 允许自由调整大小 */
            overflow: auto;
            /* 内容溢出时显示滚动条 */
        }

        .edit-option input[type="text"] {
            flex: 1;
        }

        .edit-option input[type="checkbox"] {
            margin-right: 5px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            display: block !important;
            max-width: 100%;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 题目图片样式 */
        .question-image {
            display: block;
            max-width: 100%;
            margin: 10px auto;
            border-radius: 4px;
        }

        /* 选项图片样式 */
        .option-image {
            display: inline-block;
            max-width: 80%;
            max-height: 100px;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* 解析图片样式 */
        .explanation-image {
            display: block;
            max-width: 100%;
            margin: 10px 0;
            border-radius: 4px;
        }

        .image-upload {
            margin-top: 5px;
        }

        .edit-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .edit-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }

        .edit-tab.active {
            background-color: #f5f5f5;
            border-color: #ddd #ddd #f5f5f5;
        }

        .edit-tab-content {
            display: none;
        }

        .edit-tab-content.active {
            display: block;
        }

        #explanationEditTextarea {
            min-height: 150px;
            /* 最小高度 */
            min-width: 300px;
            /* 最小宽度 */
            resize: both;
            /* 允许水平和垂直方向自由调整 */
            overflow: auto;
            /* 内容溢出时显示滚动条 */
        }

        .back-mode-option {
            background-color: var(--light-bg) !important;
            border-left: 4px solid transparent !important;
            cursor: default !important;
            /* 禁用指针变化 */
            pointer-events: none !important;
            /* 禁用所有鼠标事件 */
        }

        /* 保留正确答案样式 */
        .back-mode-option.correct-answer {
            background-color: #e8f5e9 !important;
            border-left-color: var(--correct-color) !important;
            color: #2e7d32;
        }

        .back-mode-option.correct-answer .option-letter {
            background-color: var(--correct-color) !important;
            color: white !important;
        }

        /* 添加在样式表中 */
        .hidden {
            display: none !important;
        }

        /* 导出选项按钮样式 */
        .export-option-button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* 模拟考试样式 */
        .exam-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .exam-timer {
            font-weight: bold;
            color: #f44336;
        }

        .exam-progress {
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .exam-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .score-display div {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .answer-sheet-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .answer-sheet-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .answer-sheet-btn.answered {
            background-color: #4CAF50;
            color: white;
        }

        .answer-sheet-btn.current {
            border: 2px solid #2196F3;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .exam-review-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .exam-review-correct {
            background-color: #e8f5e9;
        }

        .exam-review-wrong {
            background-color: #ffebee;
        }

        /* 考试历史样式 */
        .exam-history-list {
            margin-top: 15px;
        }

        .exam-history-item {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exam-history-info {
            flex: 1;
        }

        .exam-history-actions {
            display: flex;
            gap: 10px;
        }

        .icon-exam {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 12h2v5H7zm8-7h2v3h-2zm-8 3h2v4H7zm4-3h2v2h-2zm4 3h2v4h-2z"/></svg>');
        }

        .exam-review-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 4px;
        }

        .exam-review-correct {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }

        .exam-review-wrong {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }

        .exam-review-options {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }

        .exam-review-options div {
            margin: 5px 0;
            padding: 5px;
        }

        /* 添加在原有样式之后 */
        .icon-info {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232196F3"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>');
        }

        /* 更多页面按钮样式 */
        #more-page .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        #more-page .action-buttons button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            font-size: 16px;
        }

        #more-page .action-buttons button i {
            display: none;
            /*margin-right: 10px;*/
        }

        .nav-bar.hidden {
            display: none !important;
        }

        /* 添加填空题和简答题的样式 */
        .fill-blank-input {
            border-bottom: 1px solid #333;
            min-width: 100px;
            padding: 2px 5px;
            margin: 0 5px;
        }

        .answer-display {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 3px solid var(--correct-color);
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        .header {
            padding: 15px;
            background-color: var(--header-bg);
            color: var(--header-text);
            font-size: 18px;
            font-weight: bold;
            position: relative;
            display: flex;
            flex-direction: column;
            /* 改为垂直布局 */
            justify-content: center;
            align-items: center;
            height: 70px;
            /* 设置固定高度 */
        }

        #main-title {
            text-align: center;
            margin-bottom: 5px;
            /* 添加底部间距 */
        }

        .subtitle {
            font-size: 12px;
            opacity: 0.8;
            text-align: center;
            margin-top: 0;
            /* 移除之前的绝对定位 */
            position: static;
            /* 改为静态定位 */
        }

        .menu-button {
            position: absolute;
            right: 15px;
            width: 30px;
            height: 30px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
        }

        .menu-button::before {
            content: "⋮";
            color: white;
            font-size: 20px;
            line-height: 1;
        }

        /* 调整按钮容器位置 */
        .action-buttons-container {
            position: relative;
            margin-bottom: 15px;
        }

        .action-buttons.hidden-buttons {
            display: none;
            position: absolute;
            top: 50px;
            /* 从标题栏下方开始 */
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            flex-direction: column;
            gap: 5px;
        }

        .action-buttons.hidden-buttons button {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }



    </style>
</head>
<body>
    <div class="container">
        <!-- 修改标题栏部分 -->
        <div class="header">
            <div id="main-title">
                本地刷题
            </div>
            <div id="sub-title" class="subtitle"></div>

            <!-- 为每个页面添加菜单按钮 -->
            <div class="menu-button" onclick="toggleActionButtons('practice')" id="practice-menu-button"></div>
            <div class="menu-button" onclick="toggleActionButtons('back')" id="back-menu-button"></div>
            <div class="menu-button" onclick="toggleActionButtons('wrong')" id="wrong-menu-button"></div>
            <div class="menu-button" onclick="toggleActionButtons('favorite')" id="favorite-menu-button"></div>
        </div>

        <div id="bank-page" class="page active">
            <div class="content">
                <div class="library-manager">
                    <div class="action-buttons">
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls">
                        <button id="createLibraryButton" class="button button-primary">创建新题库</button>
                        <button id="importButton" class="button button-success">导入新题库</button>
                        <button id="editLibraryButton" class="button button-primary">编辑当前题库</button>
                        <button id="deleteLibraryButton" class="button button-danger">删除当前题库</button>
                        <button id="resetLibraryButton" class="button button-warning">重置题库</button>
                        <button id="exportButton" class="button button-primary">导出当前题库</button>
                    </div>
                    <div id="library-list" class="library-list"></div>

                    <!-- 添加编辑区域 -->
                    <div id="edit-container" class="edit-container hidden">
                        <button id="cancelEditButton" class="button button-danger" style="margin-bottom: 15px;">退出编辑</button>
                        <div class="edit-tabs">
                            <div class="edit-tab active" onclick="quizApp.switchEditTab('questions')">
                                题目列表
                            </div>
                            <div class="edit-tab" onclick="quizApp.switchEditTab('edit')">
                                编辑题目
                            </div>
                        </div>

                        <!-- 添加搜索框 -->
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="questionSearchInput" placeholder="搜索题目..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="quizApp.searchQuestions()" class="button button-primary" style="margin-top: 5px;">搜索</button>
                            <button onclick="quizApp.clearSearch()" class="button button-warning" style="margin-top: 5px;">清除搜索</button>
                        </div>

                        <div id="questions-tab" class="edit-tab-content active">
                            <div id="question-list"></div>
                        </div>

                        <div id="edit-tab" class="edit-tab-content">
                            <div class="edit-form">
                                <div>
                                    <label>题目内容</label>
                                    <textarea id="edit-question"></textarea>
                                    <div class="image-upload">
                                        <input type="file" id="question-image" accept="image/*">
                                        <button onclick="quizApp.uploadImage('question')">上传图片</button>

                                        <button onclick="quizApp.removeImage('question')" class="button button-danger hidden">删除图片</button>
                                    </div>
                                </div>

                                <div>
                                    <label>题目类型</label>
                                    <select id="edit-type">
                                        <option value="单选">单选题</option>
                                        <option value="多选">多选题</option>
                                    </select>
                                </div>

                                <div class="edit-options">
                                    <label>选项</label>
                                    <div id="edit-options-container"></div>
                                    <button onclick="quizApp.addOption()" class="button button-primary">添加选项</button>
                                </div>

                                <div>
                                    <label>正确答案</label>
                                    <input type="text" id="edit-answer" placeholder="如A或AB">
                                </div>

                                <div>
                                    <label>解析</label>
                                    <textarea id="edit-explanation"></textarea>
                                    <div class="image-upload">
                                        <input type="file" id="explanation-image" accept="image/*">
                                        <button onclick="quizApp.uploadImage('explanation')">上传图片</button>

                                        <button onclick="quizApp.removeImage('explanation')" class="button button-danger hidden">删除图片</button>
                                    </div>
                                </div>

                                <div class="edit-actions">
                                    <button onclick="quizApp.saveQuestion()" class="button button-success">保存</button>
                                    <button onclick="quizApp.cancelEdit()" class="button button-danger">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="practice-page" class="page">
            <div class="content">
                <div class="progress-container">
                    <div id="status-info" class="status-info"></div>
                    <div class="progress-bar">
                        <div id="progress" class="progress"></div>
                    </div>
                </div>

                <!-- 练习页面 -->
                <!-- 修改练习页面的action-buttons部分 -->
                <div class="action-buttons-container">
                    <div class="menu-button" onclick="toggleActionButtons('practice')"></div>
                    <div id="practice-action-buttons" class="action-buttons hidden-buttons">
                        <button id="shuffleButton" class="button button-primary">顺序练习</button>
                        <button id="resetPracticeButton" class="button button-warning">重置练习</button>
                        <button id="exportPracticeButton" class="button button-success">导出练习题目</button>
                        <button id="editQuestionButton" class="button button-primary">编辑题目</button>
                        <button id="deleteQuestionButton" class="button button-danger hidden">删除题目</button>
                        <input type="number" id="jumpInput" placeholder="题号" min="1">
                        <button id="jumpButton" class="button button-primary">跳转</button>
                    </div>
                </div>
                <div id="question-container" class="question-container">
                    <div id="question" class="question"></div>
                    <div id="options"></div>
                    <div id="answer-result"></div>

                    <div id="answer-container" class="answer-container hidden">
                        <strong>正确答案：</strong><span id="correct-answer"></span>
                    </div>

                    <!-- 修改解析部分，添加编辑按钮 -->
                    <div id="explanation-container" class="explanation-container hidden">
                        <div class="explanation-header">
                            <strong>解析：</strong>
                            <button id="editExplanationButton" class="button button-primary">编辑解析</button>
                        </div>
                        <span id="explanation"></span>
                    </div>

                    <!-- 添加编辑解析的模态框 -->
                    <div id="editExplanationModal" class="modal hidden">
                        <div class="modal-content">
                            <h3>编辑解析</h3>
                            <textarea id="explanationEditTextarea" rows="5"></textarea>
                            <div class="modal-actions">
                                <button id="saveExplanationButton" class="button button-success">保存</button>
                                <button id="cancelExplanationEditButton" class="button button-danger">取消</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 替换原来的导航部分 -->
                <div class="navigation">
                    <button id="prevButton" class="button button-primary">上一题</button>
                    <button id="favoriteButton" class="button button-warning">收藏本题</button>
                    <button id="nextButton" class="button button-primary">下一题</button>
                </div>

            </div>
        </div>

        <div id="back-page" class="page">
            <div class="content">
                <div class="progress-container">
                    <div id="back-status-info" class="status-info"></div>
                    <div class="progress-bar">
                        <div id="back-progress" class="progress"></div>
                    </div>
                </div>

                <!-- 修改背题页面的action-buttons部分 -->
                <div class="action-buttons-container">
                    <div class="menu-button" onclick="toggleActionButtons('back')"></div>
                    <div id="back-action-buttons" class="action-buttons hidden-buttons">
                        <button id="back-shuffleButton" class="button button-primary">顺序背题</button>
                        <button id="resetBackModeButton" class="button button-warning">重置背题</button>
                        <button id="editBackQuestionButton" class="button button-primary">编辑题目</button>
                        <button id="deleteBackQuestionButton" class="button button-danger hidden">删除题目</button>
                        <input type="number" id="back-jumpInput" placeholder="题号" min="1">
                        <button id="back-jumpButton" class="button button-primary">跳转</button>
                    </div>
                </div>
                <div id="back-question-container" class="question-container">
                    <div id="back-question" class="question"></div>
                    <div id="back-options"></div>

                    <div id="back-answer-container" class="answer-container">
                        <strong>正确答案：</strong><span id="back-correct-answer"></span>
                    </div>

                    <div id="back-explanation-container" class="explanation-container">
                        <strong>解析：</strong><span id="back-explanation"></span>
                    </div>
                </div>

                <!-- 替换原来的导航部分 -->
                <div class="navigation">
                    <button id="back-prevButton" class="button button-primary">上一题</button>
                    <button id="back-favoriteButton" class="button button-warning">收藏本题</button>
                    <button id="back-nextButton" class="button button-primary">下一题</button>
                </div>

            </div>
        </div>

        <!-- 新增错题本页面 -->
        <div id="wrong-page" class="page">
            <div class="content">
                <div class="progress-container">
                    <div id="wrong-status-info" class="status-info"></div>
                    <div class="progress-bar">
                        <div id="wrong-progress" class="progress"></div>
                    </div>
                </div>

                <!-- 修改错题本页面的action-buttons部分 -->
                <div class="action-buttons-container">
                    <div class="menu-button" onclick="toggleActionButtons('wrong')"></div>
                    <div id="wrong-action-buttons" class="action-buttons hidden-buttons">
                        <button id="practiceWrongButton" class="button button-primary">练习错题</button>
                        <button id="resetWrongModeButton" class="button button-warning">重置错题练习</button>
                        <button id="exportWrongButton" class="button button-success">导出错题</button>
                        <button id="editWrongQuestionButton" class="button button-primary">编辑题目</button>
                        <button id="deleteWrongQuestionButton" class="button button-danger hidden">删除题目</button>
                        <input type="number" id="wrong-jumpInput" placeholder="题号" min="1">
                        <button id="wrong-jumpButton" class="button button-primary">跳转</button>
                    </div>
                </div>
                <div id="wrong-question-container" class="question-container">
                    <div id="wrong-question" class="question"></div>
                    <div id="wrong-options"></div>

                    <div id="wrong-answer-container" class="answer-container">
                        <strong>正确答案：</strong><span id="wrong-correct-answer"></span>
                    </div>

                    <div id="wrong-explanation-container" class="explanation-container">
                        <strong>解析：</strong><span id="wrong-explanation"></span>
                    </div>

                    <div class="action-buttons" style="margin-top: 15px;">
                        <button id="wrong-favorite-button" class="button button-warning">收藏本题</button>
                        <button id="wrong-remove-button" class="button button-danger">移出错题本</button>
                    </div>
                </div>

                <div class="navigation">
                    <button id="wrong-prevButton" class="button button-primary">上一题</button>
                    <button id="wrong-nextButton" class="button button-primary">下一题</button>
                </div>
            </div>
        </div>

        <!-- 新增收藏本页面 -->
        <div id="favorite-page" class="page">
            <div class="content">
                <div class="progress-container">
                    <div id="favorite-status-info" class="status-info"></div>
                    <div class="progress-bar">
                        <div id="favorite-progress" class="progress"></div>
                    </div>
                </div>

                <!-- 修改收藏本页面的action-buttons部分 -->
                <div class="action-buttons-container">
                    <div class="menu-button" onclick="toggleActionButtons('favorite')"></div>
                    <div id="favorite-action-buttons" class="action-buttons hidden-buttons">
                        <button id="resetFavoriteModeButton" class="button button-warning">重置收藏</button>
                        <button id="editFavoriteQuestionButton" class="button button-primary">编辑题目</button>
                        <button id="deleteFavoriteQuestionButton" class="button button-danger hidden">删除题目</button>
                        <button id="exportFavoriteButton" class="button button-success">导出收藏</button>
                        <input type="number" id="favorite-jumpInput" placeholder="题号" min="1">
                        <button id="favorite-jumpButton" class="button button-primary">跳转</button>
                    </div>
                </div>
                <div id="favorite-question-container" class="question-container">
                    <div id="favorite-question" class="question"></div>
                    <div id="favorite-options"></div>

                    <div id="favorite-answer-container" class="answer-container">
                        <strong>正确答案：</strong><span id="favorite-correct-answer"></span>
                    </div>

                    <div id="favorite-explanation-container" class="explanation-container">
                        <strong>解析：</strong><span id="favorite-explanation"></span>
                    </div>

                    <div class="action-buttons" style="margin-top: 15px;">
                        <button id="favorite-remove-button" class="button button-danger">取消收藏</button>
                    </div>
                </div>

                <div class="navigation">
                    <button id="favorite-prevButton" class="button button-primary">上一题</button>
                    <button id="favorite-nextButton" class="button button-primary">下一题</button>
                </div>
            </div>
        </div>

        <!-- 新增模拟考试页面 -->
        <div id="exam-page" class="page">
            <div class="content">
                <!-- 考试设置区域 -->
                <div id="exam-settings" class="question-container">
                    <h3>模拟考试设置</h3>
                    <!-- 在考试设置区域添加模式切换按钮 -->
                    <div class="form-group">
                        <label>考试模式:</label>
                        <select id="exam-mode" class="form-input">
                            <option value="normal">常规模式</option>
                            <option value="timed">每题计时模式</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>考试名称:</label>
                        <input type="text" id="exam-name" placeholder="请输入考试名称" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>题目数量:</label>
                        <input type="number" id="exam-quantity" min="1" value="20" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>单选题数量:</label>
                        <input type="number" id="single-choice-count" min="0" value="0" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>多选题数量:</label>
                        <input type="number" id="multi-choice-count" min="0" value="0" class="form-input">
                    </div>
                    <!-- 修改分数设置部分，分别设置单选和多选分数 -->
                    <div class="form-group">
                        <label>单选题分数:</label>
                        <input type="number" id="single-choice-score" min="1" value="5" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>多选题分数:</label>
                        <input type="number" id="multi-choice-score" min="1" value="10" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>单选题时间(秒):</label>
                        <input type="number" id="single-choice-time" min="10" value="60" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>多选题时间(秒):</label>
                        <input type="number" id="multi-choice-time" min="10" value="90" class="form-input">
                    </div>

                    <button id="start-exam-btn" class="button button-primary">开始考试</button>

                    <!-- 新增考试历史按钮 -->
                    <button id="view-exam-history" class="button button-warning" style="margin-top: 15px;">查看考试历史</button>
                </div>

                <!-- 考试历史区域 -->
                <div id="exam-history" class="hidden">
                    <h3>考试历史记录</h3>
                    <div id="exam-history-list" class="exam-history-list"></div>
                </div>

                <!-- 考试进行中区域 -->
                <div id="exam-in-progress" class="hidden">
                    <div class="exam-header">
                        <div id="exam-timer" class="exam-timer">
                            剩余时间: 60:00
                        </div>
                        <div id="exam-progress" class="exam-progress">
                            1/20
                        </div>
                        <button id="exit-exam" class="button button-danger">退出考试</button>
                    </div>
                    <div class="question-container">
                        <div id="exam-question" class="question"></div>
                        <div id="exam-options"></div>
                    </div>
                    <div class="exam-navigation">
                        <button id="prev-exam-question" class="button button-primary">上一题</button>
                        <button id="exam-answer-sheet" class="button button-warning">答题卡</button>
                        <button id="next-exam-question" class="button button-primary">下一题</button>
                        <button id="submit-exam" class="button button-danger">交卷</button>
                    </div>
                </div>

                <!-- 答题卡模态框 -->
                <div id="answer-sheet-modal" class="modal hidden">
                    <div class="modal-content">
                        <h3>答题卡</h3>
                        <div id="answer-sheet-buttons" class="answer-sheet-grid"></div>
                        <div class="modal-actions">
                            <button id="close-answer-sheet" class="button button-primary">关闭</button>
                        </div>
                    </div>
                </div>

                <!-- 考试结果区域 -->
                <!-- 修改考试结果区域的HTML结构 -->
                <div id="exam-results" class="hidden">
                    <div class="exam-summary">
                        <h3 id="exam-result-title">考试结果</h3>
                        <div class="score-display">
                            <div>
                                总分: <span id="total-score">100</span>
                            </div>
                            <div>
                                得分: <span id="achieved-score">75</span>
                            </div>
                            <div>
                                正确率: <span id="correct-rate">75%</span>
                            </div>
                            <div>
                                用时: <span id="time-used">25:30</span>
                            </div>
                            <div>
                                单选题: <span id="single-stats">10/15</span>
                            </div>
                            <div>
                                多选题: <span id="multi-stats">5/10</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="review-exam" class="button button-primary">查看考试详情</button>
                        <button id="show-correct" class="button button-success">仅看正确</button>
                        <button id="show-wrong" class="button button-danger">仅看错题</button>

                        <button id="save-exam" class="button button-success">保存此次考试</button>
                        <button id="export-exam" class="button button-primary">导出考试</button>
                        <button id="export-wrong-answers" class="button button-danger">导出错题</button>
                        <button id="new-exam" class="button button-warning">开始新考试</button>
                    </div>

                    <div id="exam-review" class="hidden">
                        <!-- 考试题目回顾将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 修改导航栏部分 -->
        <div class="nav-bar">
            <a href="#" class="nav-button active" onclick="switchPage('bank-page', this)">
                <i class="icon icon-bank"></i>
                <span>题库</span>
            </a>
            <a href="#" class="nav-button" onclick="switchPage('practice-page', this)">
                <i class="icon icon-practice"></i>
                <span>练习</span>
            </a>
            <a href="#" class="nav-button" onclick="switchPage('back-page', this)">
                <i class="icon icon-memorize"></i>
                <span>背题</span>
            </a>
            <a href="#" class="nav-button" onclick="switchPage('more-page', this)">
                <i class="icon icon-settings"></i>
                <span>更多</span>
            </a>
        </div>

        <!-- 添加更多页面 -->
        <div id="more-page" class="page">
            <div class="content">
                <div class="action-buttons">
                    <button onclick="switchPage('wrong-page')" class="button button-danger">
                        <i class="icon icon-wrong"></i> 错题本
                    </button>
                    <button onclick="switchPage('favorite-page')" class="button button-warning">
                        <i class="icon icon-favorite"></i> 收藏本
                    </button>
                    <button onclick="switchPage('exam-page')" class="button button-primary">
                        <i class="icon icon-exam"></i> 模拟考试
                    </button>
                </div>

                <!-- 可以在这里添加其他功能按钮 -->
                <div class="action-buttons" style="margin-top: 20px;">
                    <button onclick="alert('开发中')" class="button button-primary">
                        <i class="icon icon-settings"></i> 设置
                    </button>
                    <button onclick="alert('lsf\n\nQQ：2803223529')" class="button button-primary">
                        <i class="icon icon-info"></i> 交流
                    </button>
                    <button onclick="showDonationModal()" class="button button-warning">
                        <i class="icon icon-favorite"></i> 吃个辣条
                    </button>
                </div>
                <div id="donation-modal" class="modal hidden">
                    <div class="modal-content" style="max-width: 300px;">
                        <h3 style="text-align: center; margin-bottom: 15px;">感谢支持</h3>

                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- 支付宝 -->
                            <div style="text-align: center;">
                                <a href="https://qr.alipay.com/a6x00963nidio7sxfnsbg40" target="_blank" style="text-decoration: none;">

                                    <div style="margin-top: 5px; color: #1296db;">
                                        支付宝
                                    </div>
                                </a>
                            </div>


                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="hideDonationModal()" class="button button-danger">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <a id="downloadLink" class="hidden" download="题库导出.xlsx"></a>
        </div>

        <script>
            const quizApp = {
                db: null,
                dbName: 'QuizAppDB',
                dbVersion: 1,
                data: {
                    libraries: [],
                    currentLibraryIndex: 0
                },


                async initDB() {
                    return new Promise((resolve, reject) => {
                        // 将版本号改为2，以便触发升级
                        const request = indexedDB.open(this.dbName, 2); // 修改版本号为2

                        request.onerror = (event) => {
                            console.error('Database error:', event.target.error);
                            reject(event.target.error);
                        };

                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            resolve(this.db);
                        };

                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            const oldVersion = event.oldVersion;

                            // 创建或升级题库数据存储
                            if (!db.objectStoreNames.contains('quizData')) {
                                db.createObjectStore('quizData', {
                                    keyPath: 'id'
                                });
                            }

                            // 创建或升级考试历史存储
                            if (!db.objectStoreNames.contains('examHistory')) {
                                db.createObjectStore('examHistory', {
                                    keyPath: 'id'
                                });
                            }

                            // 如果需要从旧版本升级，可以在这里添加迁移逻辑
                            if (oldVersion < 1) {
                                // 从版本0升级到1的逻辑
                            }

                            if (oldVersion < 2) {
                                // 从版本1升级到2的逻辑
                            }
                        };
                    });
                },

                // 保存数据到IndexedDB
                async saveToStorage() {
                    return new Promise((resolve, reject) => {
                        if (!this.db) {
                            reject('Database not initialized');
                            return;
                        }

                        const transaction = this.db.transaction(['quizData'], 'readwrite');
                        const store = transaction.objectStore('quizData');

                        const request = store.put({
                            id: 1,
                            data: this.data
                        });

                        request.onsuccess = () => {
                            resolve();
                        };

                        request.onerror = (event) => {
                            reject(event.target.error);
                        };
                    });
                },

                // 从IndexedDB加载数据
                async loadFromStorage() {
                    return new Promise((resolve, reject) => {
                        if (!this.db) {
                            reject('Database not initialized');
                            return;
                        }

                        const transaction = this.db.transaction(['quizData'], 'readonly');
                        const store = transaction.objectStore('quizData');

                        const request = store.get(1);

                        request.onsuccess = (event) => {
                            const result = event.target.result;
                            if (result && result.data) {
                                this.data = result.data;
                                // 初始化默认值...
                                resolve(this.data);
                            } else {
                                // 如果没有数据，初始化默认数据结构
                                this.data = {
                                    libraries: [],
                                    currentLibraryIndex: 0
                                };
                                resolve(this.data);
                            }
                        };

                        request.onerror = (event) => {
                            reject(event.target.error);
                        };
                    });
                },

                // 初始化应用
                async init() {
                    try {
                        await this.initDB();
                        await this.loadFromStorage();
                        try {
                            await this.loadExamHistory();
                        } catch (error) {
                            console.error('加载考试历史失败:',
                                error);
                            this.examData.exams = [];
                        }
                        this.setupEventListeners();
                        this.setupSwipeGestures();
                        this.setupWrongAndFavoriteListeners();
                        this.initEditMode();
                        this.setupEditButtons();
                        this.initExam(); // 初始化考试功能
                        this.updateUI();

                        document.getElementById('createLibraryButton').addEventListener('click',
                            () => {
                                this.showCreateLibraryDialog();
                            });
                        document.getElementById('edit-type').innerHTML = `
                        <option value="单选">单选题</option>
                        <option value="多选">多选题</option>
                        <option value="填空">填空题</option>
                        <option value="简答">简答题</option>
                        `;
                        document.getElementById('edit-type').addEventListener('change',
                            function() {
                                const type = this.value;
                                const optionsContainer = document.getElementById('edit-options-container');
                                const answerInput = document.getElementById('edit-answer');

                                if (type === '填空' || type === '简答') {
                                    optionsContainer.style.display = 'none';
                                    if (type === '填空') {
                                        answerInput.type = 'text';
                                        answerInput.placeholder = '请输入正确答案（多个答案用|分隔）';
                                    } else {
                                        answerInput.type = 'textarea';
                                        answerInput.placeholder = '请输入参考答案';
                                    }
                                } else {
                                    optionsContainer.style.display = 'block';
                                    answerInput.type = 'text';
                                    answerInput.placeholder = '如A或AB';
                                }
                            });
                    } catch (error) {
                        console.error('Initialization error:',
                            error);
                        // 如果IndexedDB失败，回退到默认数据结构
                        this.data = {
                            libraries: [],
                            currentLibraryIndex: 0
                        };
                        this.examData.exams = []; // 初始化空考试历史
                        this.updateUI();
                    }
                },

                // 创建新题库
                async createNewLibrary(name) {
                    this.data.libraries.push({
                        name: name,
                        questions: [],
                        practiceMode: {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        },
                        backMode: {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        },
                        userAnswers: {
                            ordered: {},
                            shuffled: {}
                        },
                        wrongQuestions: [],
                        favoriteQuestions: [],
                        wrongMode: {
                            currentIndex: 0
                        },
                        favoriteMode: {
                            currentIndex: 0
                        }
                    });

                    this.data.currentLibraryIndex = this.data.libraries.length - 1;
                    await this.saveToStorage();
                    this.updateUI();

                    // 自动进入编辑模式
                    this.showEditMode();
                },

                // 导入题库
                importLibrary: function(file) {
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {
                                type: 'array'
                            });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                            if (jsonData.length === 0) {
                                alert('导入失败：Excel文件中没有数据');
                                return;
                            }

                            // 预处理：识别共用题目并分组
                            const groupedQuestions = {};
                            const questions = [];

                            jsonData.forEach(row => {
                                const groupId = row['共用ID'] || '';

                                if (groupId) {
                                    if (!groupedQuestions[groupId]) {
                                        groupedQuestions[groupId] = [];
                                    }
                                    groupedQuestions[groupId].push(row);
                                } else {
                                    questions.push(this.processQuestionRow(row));
                                }
                            });

                            // 处理共用题目
                            for (const groupId in groupedQuestions) {
                                const group = groupedQuestions[groupId];

                                // 检查是否是共用题干
                                const hasCommonStem = group.some(q => q['类型'] === '共用题干');

                                if (hasCommonStem) {
                                    // 处理共用题干题目
                                    const commonStem = group.find(q => q['类型'] === '共用题干');
                                    const subQuestions = group.filter(q => q['类型'] !== '共用题干');

                                    subQuestions.forEach(subQ => {
                                        const question = this.processQuestionRow(subQ);
                                        question.commonStem = commonStem['题干'];
                                        question.groupId = groupId;
                                        questions.push(question);
                                    });
                                } else {
                                    // 处理共用选项题目
                                    const firstQuestion = group[0];
                                    const commonOptions = {
                                        A: firstQuestion['选项A'],
                                        B: firstQuestion['选项B'],
                                        C: firstQuestion['选项C'],
                                        D: firstQuestion['选项D'],
                                        E: firstQuestion['选项E'],
                                        F: firstQuestion['选项F'],
                                        G: firstQuestion['选项G'],
                                        H: firstQuestion['选项H']
                                    };

                                    group.forEach(q => {
                                        const question = this.processQuestionRow(q);
                                        question.commonOptions = commonOptions;
                                        question.groupId = groupId;
                                        questions.push(question);
                                    });
                                }
                            }

                            const libraryName = file.name.replace(/\.[^/.]+$/, "");

                            this.data.libraries.push({
                                name: libraryName,
                                questions: questions,
                                practiceMode: {
                                    isShuffled: false,
                                    currentIndex: 0,
                                    shuffledIndices: [],
                                    lastOrderedIndex: 0
                                },
                                backMode: {
                                    isShuffled: false,
                                    currentIndex: 0,
                                    shuffledIndices: [],
                                    lastOrderedIndex: 0
                                },
                                userAnswers: {
                                    ordered: {},
                                    shuffled: {}
                                },
                                wrongQuestions: [],
                                favoriteQuestions: [],
                                wrongMode: {
                                    currentIndex: 0
                                },
                                favoriteMode: {
                                    currentIndex: 0
                                }
                            });

                            this.data.currentLibraryIndex = this.data.libraries.length - 1;
                            await this.saveToStorage();
                            this.updateUI();

                            alert(`成功导入题库 "${libraryName}"，共 ${questions.length} 道题目`);
                        } catch (error) {
                            console.error(error);
                            alert('导入失败：' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },
                
                // 处理文本中的换行符，转换为HTML换行
formatTextWithLineBreaks: function(text) {
    if (!text) return '';
    // 将换行符转换为<br>标签，并处理连续空格
    return text.replace(/\r\n|\r|\n/g, '<br>')
               .replace(/  /g, ' &nbsp;');
},


                processQuestionRow: function(row) {
                    let questionType = (row['类型'] || '').trim();

                    if (!questionType) {
                        if (row['题干'] && row['题干'].includes('[填空]')) {
                            questionType = '填空';
                        } else if (row['答案'] && row['答案'].length > 20) {
                            questionType = '简答';
                        } else {
                            questionType = '单选';
                        }
                    }

                    const question = {
                        题干: row['题干'] || '',
                        类型: questionType,
                        答案: (row['答案'] || '').trim(),
                        解析: row['解析'] || ''
                    };

                    // 添加选项
                    const optionLetters = ['A',
                        'B',
                        'C',
                        'D',
                        'E',
                        'F',
                        'G',
                        'H'];
                    optionLetters.forEach(letter => {
                        if (row[`选项${letter}`]) {
                            question[`选项${letter}`] = row[`选项${letter}`];
                        }
                    });

                    return question;
                },

                // 删除当前题库
                async deleteCurrentLibrary() {
                    if (this.data.libraries.length === 0) return;

                    if (confirm('确定要删除当前题库吗？')) {
                        this.data.libraries.splice(this.data.currentLibraryIndex, 1);

                        if (this.data.libraries.length === 0) {
                            this.data.currentLibraryIndex = 0;
                        } else if (this.data.currentLibraryIndex >= this.data.libraries.length) {
                            this.data.currentLibraryIndex = this.data.libraries.length - 1;
                        }

                        await this.saveToStorage();
                        this.updateUI();
                    }
                },

                // 重置当前题库
                async resetCurrentLibrary() {
                    const library = this.getCurrentLibrary();
                    if (!library) return;

                    if (confirm('确定要重置当前题库吗？这将清空所有练习记录')) {
                        library.practiceMode = {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        };
                        library.backMode = {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        };
                        library.userAnswers = {
                            ordered: {},
                            shuffled: {}
                        };
                        library.wrongQuestions = [];
                        library.favoriteQuestions = [];
                        library.wrongMode.currentIndex = 0;
                        library.favoriteMode.currentIndex = 0;

                        await this.saveToStorage();
                        this.updateUI();
                    }
                },

                // 切换随机模式
                async toggleShuffleMode(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    mode.isShuffled = !mode.isShuffled;

                    if (mode.isShuffled && mode.shuffledIndices.length === 0) {
                        this.generateShuffledIndices(isBackMode);
                    }

                    await this.saveToStorage();

                    if (isBackMode) {
                        this.updateBackModeUI();
                    } else {
                        this.updatePracticeModeUI(false);
                    }
                },

                // 重置练习模式
                async resetPracticeMode() {
                    const library = this.getCurrentLibrary();
                    if (!library) return;

                    if (confirm('确定要重置练习模式吗？这将清空所有练习记录')) {
                        library.practiceMode = {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        };
                        library.userAnswers.ordered = {};
                        library.userAnswers.shuffled = {};

                        await this.saveToStorage();
                        this.updatePracticeModeUI(false);
                    }
                },

                // 重置背题模式
                async resetBackMode() {
                    const library = this.getCurrentLibrary();
                    if (!library) return;

                    if (confirm('确定要重置背题模式吗？这将清空所有背题记录')) {
                        library.backMode = {
                            isShuffled: false,
                            currentIndex: 0,
                            shuffledIndices: [],
                            lastOrderedIndex: 0
                        };

                        await this.saveToStorage();
                        this.updateBackModeUI();
                    }
                },

                // 跳转到指定题目
                async jumpToQuestion(isBackMode) {
                    const input = isBackMode ? document.getElementById('back-jumpInput'): document.getElementById('jumpInput');
                    const jumpTo = parseInt(input.value) - 1;
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    if (!isNaN(jumpTo) && jumpTo >= 0 && jumpTo < library.questions.length) {
                        mode.currentIndex = jumpTo;

                        if (mode.isShuffled) {
                            const questionIndex = mode.shuffledIndices.indexOf(jumpTo);
                            if (questionIndex !== -1) {
                                mode.currentIndex = questionIndex;
                            } else {
                                mode.shuffledIndices.push(jumpTo);
                                mode.currentIndex = mode.shuffledIndices.length - 1;
                            }
                        }

                        await this.saveToStorage();

                        if (isBackMode) {
                            this.updateBackModeUI();
                        } else {
                            this.updatePracticeModeUI(false);
                        }
                    } else {
                        alert(`请输入1-${library.questions.length}之间的有效题号`);
                        input.value = mode.isShuffled ?
                        (mode.shuffledIndices[mode.currentIndex] + 1):
                        (mode.currentIndex + 1);
                    }
                },

                // 上一题
                async prevQuestion(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    if (mode.currentIndex > 0) {
                        mode.currentIndex--;
                        await this.saveToStorage();

                        if (isBackMode) {
                            this.updateBackModeUI();
                        } else {
                            this.updatePracticeModeUI(false);
                        }
                    } else {
                        alert('已经是第一题了');
                    }
                },

                // 下一题
                async nextQuestion(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;
                    const totalQuestions = library.questions.length;

                    if (mode.currentIndex < totalQuestions - 1) {
                        mode.currentIndex++;

                        if (mode.isShuffled && mode.currentIndex >= mode.shuffledIndices.length) {
                            const remainingQuestions = Array.from({
                                length: totalQuestions
                            }, (_, i) => i)
                            .filter(i => !mode.shuffledIndices.includes(i));

                            if (remainingQuestions.length > 0) {
                                const randomIndex = Math.floor(Math.random() * remainingQuestions.length);
                                mode.shuffledIndices.push(remainingQuestions[randomIndex]);
                            } else {
                                this.generateShuffledIndices(isBackMode);
                            }
                        }

                        await this.saveToStorage();

                        if (isBackMode) {
                            this.updateBackModeUI();
                        } else {
                            this.updatePracticeModeUI(false);
                        }
                    } else {
                        alert('已经是最后一题了');
                    }
                },

                // 选择选项
                async selectOption(optionLetter) {
                    const currentQuestion = this.getCurrentQuestion(false);
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    if (currentQuestion.类型 === '填空') {
                        const inputs = document.querySelectorAll('.fill-blank-input');
                        const userAnswer = Array.from(inputs).map(input => input.value.trim()).join('|');

                        userAnswers[currentIndex] = {
                            selected: userAnswer,
                            isCorrect: this.checkTextAnswer(userAnswer, currentQuestion.答案, '填空'),
                            isSubmitted: true
                        };

                        await this.saveToStorage();
                        this.updateOptionStyles(false);

                        // 显示结果
                        const resultDiv = document.getElementById('answer-result');
                        if (userAnswers[currentIndex].isCorrect) {
                            resultDiv.textContent = '回答正确';
                            resultDiv.style.color = 'var(--correct-color)';
                        } else {
                            resultDiv.textContent = `回答错误，正确答案是 ${currentQuestion.答案}`;
                            resultDiv.style.color = 'var(--wrong-color)';
                        }
                    }

                    if (currentQuestion.类型 === '多选') return;

                    userAnswers[currentIndex] = {
                        selected: optionLetter,
                        isCorrect: optionLetter === currentQuestion.答案,
                        isSubmitted: true
                    };

                    if (optionLetter !== currentQuestion.答案) {
                        await this.addToWrongQuestions(currentIndex);
                        if (document.querySelector('.page.active').id === 'wrong-page') {
                            this.updateWrongModeUI();
                        }
                    }

                    await this.saveToStorage();
                    this.updateOptionStyles(false);

                    const resultDiv = document.getElementById('answer-result');
                    if (optionLetter === currentQuestion.答案) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = `回答错误，你的答案是 ${optionLetter}`;
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    document.getElementById('correct-answer').textContent = currentQuestion.答案;
                    document.getElementById('explanation').textContent = currentQuestion.解析 || '暂无解析';
                    document.getElementById('answer-container').classList.remove('hidden');
                    document.getElementById('explanation-container').classList.remove('hidden');
                },

                // 提交多选题答案
                async submitMultiSelectAnswer() {
                    const currentQuestion = this.getCurrentQuestion(false);
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    const userAnswer = userAnswers[currentIndex] || {
                        selected: []
                    };

                    if (userAnswer.selected.length === 0) {
                        alert('请至少选择一个选项');
                        return;
                    }

                    const userAnswerStr = userAnswer.selected.sort().join('');
                    const correctAnswerStr = currentQuestion.答案.split('').sort().join('');

                    userAnswer.isCorrect = userAnswerStr === correctAnswerStr;
                    userAnswer.isSubmitted = true;

                    if (!userAnswer.isCorrect) {
                        await this.addToWrongQuestions(currentIndex);
                        if (document.querySelector('.page.active').id === 'wrong-page') {
                            this.updateWrongModeUI();
                        }
                    }

                    userAnswers[currentIndex] = userAnswer;
                    await this.saveToStorage();
                    this.updateOptionStyles(false);

                    const resultDiv = document.getElementById('answer-result');
                    if (userAnswer.isCorrect) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = `回答错误，你的答案是 ${userAnswer.selected.join(',')}`;
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    document.getElementById('correct-answer').textContent = currentQuestion.答案;
                    document.getElementById('explanation').textContent = currentQuestion.解析 || '暂无解析';
                    document.getElementById('answer-container').classList.remove('hidden');
                    document.getElementById('explanation-container').classList.remove('hidden');

                    this.updatePracticeModeUI(false);
                },

                // 切换多选题选项
                async toggleMultiSelectOption(optionLetter) {
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    if (!userAnswers[currentIndex]) {
                        userAnswers[currentIndex] = {
                            selected: [],
                            isSubmitted: false
                        };
                    }

                    const userAnswer = userAnswers[currentIndex];
                    const optionIndex = userAnswer.selected.indexOf(optionLetter);

                    if (optionIndex === -1) {
                        userAnswer.selected.push(optionLetter);
                    } else {
                        userAnswer.selected.splice(optionIndex, 1);
                    }

                    await this.saveToStorage();
                    this.updateOptionStyles(false);
                },

                // 添加到错题本
                async addToWrongQuestions(questionIndex) {
                    const library = this.getCurrentLibrary();
                    if (!library.wrongQuestions.includes(questionIndex)) {
                        library.wrongQuestions.push(questionIndex);
                        await this.saveToStorage();

                        if (document.querySelector('.page.active').id === 'wrong-page') {
                            this.updateWrongModeUI();
                        }
                    }
                },

                // 从错题本移除
                async removeFromWrongQuestions(questionIndex) {
                    const library = this.getCurrentLibrary();
                    const index = library.wrongQuestions.indexOf(questionIndex);
                    if (index !== -1) {
                        library.wrongQuestions.splice(index, 1);
                        await this.saveToStorage();

                        if (document.querySelector('.page.active').id === 'wrong-page') {
                            this.updateWrongModeUI();
                        }
                        return true;
                    }
                    return false;
                },

                // 切换收藏状态
                async toggleFavoriteQuestion(questionIndex) {
                    const library = this.getCurrentLibrary();
                    const index = library.favoriteQuestions.indexOf(questionIndex);
                    if (index === -1) {
                        library.favoriteQuestions.push(questionIndex);
                    } else {
                        library.favoriteQuestions.splice(index, 1);
                    }
                    await this.saveToStorage();

                    const activePage = document.querySelector('.page.active').id;
                    if (activePage === 'favorite-page') {
                        this.updateFavoriteModeUI();
                    } else if (activePage === 'wrong-page') {
                        this.updateWrongModeUI();
                    }

                    return index === -1;
                },

                // 保存题目
                async saveQuestion() {
                    const library = this.getCurrentLibrary();
                    const index = this.editData.currentEditIndex;

                    const question = {
                        题干: document.getElementById('edit-question').value,
                        类型: document.getElementById('edit-type').value,
                        答案: document.getElementById('edit-answer').value.toUpperCase(),
                        解析: document.getElementById('edit-explanation').value
                    };

                    if (this.editData.images.question) {
                        question.questionImage = this.editData.images.question;
                    }

                    if (this.editData.images.explanation) {
                        question.explanationImage = this.editData.images.explanation;
                    }

                    const optionsContainer = document.getElementById('edit-options-container');
                    const optionDivs = optionsContainer.querySelectorAll('.edit-option');

                    optionDivs.forEach(div => {
                        const letter = div.querySelector('select').value;
                        const text = div.querySelector('textarea').value;
                        const imagePreview = div.querySelector('img');

                        question[`选项${letter}`] = text;

                        if (imagePreview && imagePreview.style.display !== 'none') {
                            question[`选项${letter}Image`] = imagePreview.src;
                        } else {
                            delete question[`选项${letter}Image`];
                        }
                    });

                    if (index === -1) {
                        library.questions.push(question);
                    } else {
                        library.questions[index] = question;
                    }

                    await this.saveToStorage();
                    this.switchEditTab('questions');
                    this.updateQuestionList();
                    this.resetEditForm();

                    alert('题目保存成功！');
                },

                // 删除题目
                async deleteQuestion(index) {
                    if (confirm('确定要删除这道题目吗？')) {
                        const library = this.getCurrentLibrary();
                        library.questions.splice(index, 1);

                        library.wrongQuestions = library.wrongQuestions.map(i => i > index ? i - 1: i).filter(i => i !== index);
                        library.favoriteQuestions = library.favoriteQuestions.map(i => i > index ? i - 1: i).filter(i => i !== index);

                        await this.saveToStorage();
                        this.updateQuestionList();

                        if (this.editData.currentEditIndex === index) {
                            this.resetEditForm();
                            this.switchEditTab('questions');
                        }
                    }
                },

                // 重置错题本
                async resetWrongMode() {
                    const library = this.getCurrentLibrary();
                    if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                        if (confirm('确定要重置错题练习吗？这将清空所有错题练习记录')) {
                            library.wrongPracticeMode.userAnswers = {};
                            await this.saveToStorage();
                            this.updateWrongModeUI();
                        }
                    } else {
                        if (confirm('确定要重置错题本吗？这将清空所有错题记录')) {
                            library.wrongQuestions = [];
                            library.wrongMode.currentIndex = 0;
                            await this.saveToStorage();
                            this.updateWrongModeUI();
                        }
                    }
                },

                // 重置收藏本
                async resetFavoriteMode() {
                    const library = this.getCurrentLibrary();
                    if (confirm('确定要重置收藏本吗？这将清空所有收藏记录')) {
                        library.favoriteQuestions = [];
                        library.favoriteMode.currentIndex = 0;
                        await this.saveToStorage();
                        this.updateFavoriteModeUI();
                    }
                },

                // 错题本中选择选项
                async selectOptionInWrongMode(optionLetter) {
                    const library = this.getCurrentLibrary();
                    const currentQuestionIndex = library.wrongQuestions[library.wrongMode.currentIndex];
                    const currentQuestion = library.questions[currentQuestionIndex];

                    if (!library.wrongPracticeMode.userAnswers[currentQuestionIndex]) {
                        library.wrongPracticeMode.userAnswers[currentQuestionIndex] = {
                            selected: optionLetter,
                            isCorrect: optionLetter === currentQuestion.答案,
                            isSubmitted: true
                        };
                    } else {
                        library.wrongPracticeMode.userAnswers[currentQuestionIndex].selected = optionLetter;
                        library.wrongPracticeMode.userAnswers[currentQuestionIndex].isCorrect =
                        optionLetter === currentQuestion.答案;
                        library.wrongPracticeMode.userAnswers[currentQuestionIndex].isSubmitted = true;
                    }

                    await this.saveToStorage();
                    this.updateWrongModeUI();

                    const resultDiv = document.createElement('div');
                    resultDiv.style.marginTop = '15px';
                    resultDiv.style.padding = '10px';
                    resultDiv.style.borderRadius = '4px';

                    if (optionLetter === currentQuestion.答案) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.backgroundColor = '#e8f5e9';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = `回答错误，你的答案是 ${optionLetter}`;
                        resultDiv.style.backgroundColor = '#ffebee';
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    const oldResult = document.querySelector('#wrong-options .answer-result');
                    if (oldResult) oldResult.remove();

                    resultDiv.className = 'answer-result';
                    document.getElementById('wrong-options').appendChild(resultDiv);

                    document.getElementById('wrong-answer-container').classList.remove('hidden');
                    document.getElementById('wrong-explanation-container').classList.remove('hidden');
                },

                // 错题本中提交多选题答案
                async submitMultiSelectAnswerInWrongMode() {
                    const library = this.getCurrentLibrary();
                    const currentQuestionIndex = library.wrongQuestions[library.wrongMode.currentIndex];
                    const currentQuestion = library.questions[currentQuestionIndex];

                    const userAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];

                    if (!userAnswer || userAnswer.selected.length === 0) {
                        alert('请至少选择一个选项');
                        return;
                    }

                    const userAnswerStr = userAnswer.selected.sort().join('');
                    const correctAnswerStr = currentQuestion.答案.split('').sort().join('');

                    userAnswer.isCorrect = userAnswerStr === correctAnswerStr;
                    userAnswer.isSubmitted = true;

                    await this.saveToStorage();
                    this.updateWrongModeUI();

                    const resultDiv = document.createElement('div');
                    resultDiv.style.marginTop = '15px';
                    resultDiv.style.padding = '10px';
                    resultDiv.style.borderRadius = '4px';

                    if (userAnswer.isCorrect) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.backgroundColor = '#e8f5e9';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = `回答错误，你的答案是 ${userAnswer.selected.join(',')}`;
                        resultDiv.style.backgroundColor = '#ffebee';
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    const oldResult = document.querySelector('#wrong-options .answer-result');
                    if (oldResult) oldResult.remove();

                    resultDiv.className = 'answer-result';
                    document.getElementById('wrong-options').appendChild(resultDiv);

                    document.getElementById('wrong-answer-container').classList.remove('hidden');
                    document.getElementById('wrong-explanation-container').classList.remove('hidden');
                },

                // 从收藏本移除
                async removeFromFavoriteMode() {
                    const library = this.getCurrentLibrary();
                    const currentQuestionIndex = library.favoriteQuestions[library.favoriteMode.currentIndex];

                    if (confirm('确定要从收藏本中移除这道题吗？')) {
                        await this.toggleFavoriteQuestion(currentQuestionIndex);

                        if (library.favoriteMode.currentIndex >= library.favoriteQuestions.length) {
                            library.favoriteMode.currentIndex = Math.max(0, library.favoriteQuestions.length - 1);
                        }

                        await this.saveToStorage();
                        this.updateFavoriteModeUI();
                    }
                },

                // 在 quizApp 对象中添加以下方法
                searchQuestions() {
                    const searchTerm = document.getElementById('questionSearchInput').value.trim().toLowerCase();
                    if (!searchTerm) {
                        this.updateQuestionList();
                        return;
                    }

                    const library = this.getCurrentLibrary();
                    const filteredQuestions = library.questions.filter((question, index) => {
                        return question.题干.toLowerCase().includes(searchTerm);
                    });

                    this.displayFilteredQuestions(filteredQuestions);
                },

                displayFilteredQuestions(filteredQuestions) {
                    const questionList = document.getElementById('question-list');
                    questionList.innerHTML = '';

                    if (filteredQuestions.length === 0) {
                        questionList.innerHTML = '<p>没有找到匹配的题目</p>';
                        return;
                    }

                    const library = this.getCurrentLibrary();

                    filteredQuestions.forEach((question, filteredIndex) => {
                        // 找到原始索引
                        const originalIndex = library.questions.indexOf(question);

                        const item = document.createElement('div');
                        item.className = 'library-item';
                        item.style.marginBottom = '5px';
                        item.style.cursor = 'pointer';

                        const questionText = document.createElement('span');
                        questionText.textContent = `${filteredIndex + 1}. ${question.题干.substring(0, 30)}${question.题干.length > 30 ? '...': ''}`;

                        const editBtn = document.createElement('button');
                        editBtn.className = 'button button-primary';
                        editBtn.textContent = '编辑';
                        editBtn.style.marginLeft = '10px';
                        editBtn.style.padding = '2px 8px';
                        editBtn.style.fontSize = '12px';
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.editQuestion(originalIndex);
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'button button-danger';
                        deleteBtn.textContent = '删除';
                        deleteBtn.style.marginLeft = '5px';
                        deleteBtn.style.padding = '2px 8px';
                        deleteBtn.style.fontSize = '12px';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.deleteQuestion(originalIndex);
                        });

                        item.appendChild(questionText);
                        item.appendChild(editBtn);
                        item.appendChild(deleteBtn);

                        item.addEventListener('click', () => {
                            this.editQuestion(originalIndex);
                        });

                        questionList.appendChild(item);
                    });
                },

                clearSearch() {
                    document.getElementById('questionSearchInput').value = '';
                    this.updateQuestionList();
                },

                setupPracticeEditButtons() {
                    const editBtn = document.getElementById('editQuestionButton');
                    const deleteBtn = document.getElementById('deleteQuestionButton');

                    if (!editBtn || !deleteBtn) return;

                    editBtn.addEventListener('click', () => {
                        const library = this.getCurrentLibrary();
                        if (!library || library.questions.length === 0) {
                            alert('当前题库为空，无法编辑');
                            return;
                        }

                        const mode = library.practiceMode;
                        const questionIndex = mode.isShuffled ?
                        mode.shuffledIndices[mode.currentIndex]:
                        mode.currentIndex;

                        if (this.editData.isEditing) {
                            // 退出编辑模式
                            this.editData.isEditing = false;
                            editBtn.textContent = '编辑题目';
                            deleteBtn.classList.add('hidden');
                            document.getElementById('editExplanationButton').style.pointerEvents = 'auto';
                        } else {
                            // 进入编辑模式
                            this.editData.isEditing = true;
                            editBtn.textContent = '退出编辑';
                            deleteBtn.classList.remove('hidden');
                            document.getElementById('editExplanationButton').style.pointerEvents = 'none';

                            // 跳转到题库页面的编辑模式
                            switchPage('bank-page', document.querySelector('.nav-button'));
                            this.showEditMode();
                            this.editQuestion(questionIndex);
                        }
                    });

                    // 删除题目按钮
                    document.getElementById('deleteQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            const mode = library.practiceMode;
                            const questionIndex = mode.isShuffled ?
                            mode.shuffledIndices[mode.currentIndex]:
                            mode.currentIndex;

                            if (confirm('确定要删除这道题目吗？')) {
                                this.deleteQuestion(questionIndex);
                                this.updatePracticeModeUI(false);

                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteQuestionButton').classList.add('hidden');

                                // 恢复解析编辑按钮
                                document.getElementById('editExplanationButton').style.pointerEvents = 'auto';
                            }
                        });

                    // 编辑解析按钮
                    document.getElementById('editExplanationButton').addEventListener('click',
                        () => {
                            // 如果在编辑题目模式下，不允许编辑解析
                            if (this.editData.isEditing) {
                                alert('请先退出题目编辑模式');
                                return;
                            }

                            const library = this.getCurrentLibrary();
                            const mode = library.practiceMode;
                            const questionIndex = mode.isShuffled ?
                            mode.shuffledIndices[mode.currentIndex]:
                            mode.currentIndex;
                            const question = library.questions[questionIndex];

                            document.getElementById('explanationEditTextarea').value = question.解析 || '';
                            document.getElementById('editExplanationModal').classList.remove('hidden');
                        });

                    // 保存解析
                    document.getElementById('saveExplanationButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            const mode = library.practiceMode;
                            const questionIndex = mode.isShuffled ?
                            mode.shuffledIndices[mode.currentIndex]:
                            mode.currentIndex;

                            library.questions[questionIndex].解析 = document.getElementById('explanationEditTextarea').value;
                            this.saveToStorage();
                            document.getElementById('editExplanationModal').classList.add('hidden');
                            this.updatePracticeModeUI(false);
                        });

                    // 取消编辑解析
                    document.getElementById('cancelExplanationEditButton').addEventListener('click',
                        () => {
                            document.getElementById('editExplanationModal').classList.add('hidden');
                        });
                },

                setupEditButtons() {
                    // 练习模式编辑按钮
                    this.setupPracticeEditButtons();

                    // 背题模式编辑按钮
                    document.getElementById('editBackQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            if (!library || library.questions.length === 0) {
                                alert('当前题库为空，无法编辑');
                                return;
                            }

                            const mode = library.backMode;
                            const questionIndex = mode.isShuffled ?
                            mode.shuffledIndices[mode.currentIndex]:
                            mode.currentIndex;

                            if (this.editData.isEditing) {
                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editBackQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteBackQuestionButton').classList.add('hidden');
                            } else {
                                // 进入编辑模式
                                this.editData.isEditing = true;
                                document.getElementById('editBackQuestionButton').textContent = '退出编辑';
                                document.getElementById('deleteBackQuestionButton').classList.remove('hidden');

                                // 跳转到题库页面的编辑模式
                                switchPage('bank-page', document.querySelector('.nav-button'));
                                this.showEditMode();
                                this.editQuestion(questionIndex);
                            }
                        });

                    // 背题模式删除题目按钮
                    document.getElementById('deleteBackQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            const mode = library.backMode;
                            const questionIndex = mode.isShuffled ?
                            mode.shuffledIndices[mode.currentIndex]:
                            mode.currentIndex;

                            if (confirm('确定要删除这道题目吗？')) {
                                this.deleteQuestion(questionIndex);
                                this.updateBackModeUI();

                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editBackQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteBackQuestionButton').classList.add('hidden');
                            }
                        });

                    // 错题模式编辑按钮
                    document.getElementById('editWrongQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            if (!library || library.questions.length === 0) {
                                alert('当前题库为空，无法编辑');
                                return;
                            }

                            const questionIndex = library.wrongQuestions[library.wrongMode.currentIndex];

                            if (this.editData.isEditing) {
                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editWrongQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteWrongQuestionButton').classList.add('hidden');
                            } else {
                                // 进入编辑模式
                                this.editData.isEditing = true;
                                document.getElementById('editWrongQuestionButton').textContent = '退出编辑';
                                document.getElementById('deleteWrongQuestionButton').classList.remove('hidden');

                                // 跳转到题库页面的编辑模式
                                switchPage('bank-page', document.querySelector('.nav-button'));
                                this.showEditMode();
                                this.editQuestion(questionIndex);
                            }
                        });

                    // 错题模式删除题目按钮
                    document.getElementById('deleteWrongQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            const questionIndex = library.wrongQuestions[library.wrongMode.currentIndex];

                            if (confirm('确定要删除这道题目吗？')) {
                                this.deleteQuestion(questionIndex);
                                this.updateWrongModeUI();

                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editWrongQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteWrongQuestionButton').classList.add('hidden');
                            }
                        });

                    // 收藏模式编辑按钮
                    document.getElementById('editFavoriteQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            if (!library || library.questions.length === 0) {
                                alert('当前题库为空，无法编辑');
                                return;
                            }

                            const questionIndex = library.favoriteQuestions[library.favoriteMode.currentIndex];

                            if (this.editData.isEditing) {
                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editFavoriteQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteFavoriteQuestionButton').classList.add('hidden');
                            } else {
                                // 进入编辑模式
                                this.editData.isEditing = true;
                                document.getElementById('editFavoriteQuestionButton').textContent = '退出编辑';
                                document.getElementById('deleteFavoriteQuestionButton').classList.remove('hidden');

                                // 跳转到题库页面的编辑模式
                                switchPage('bank-page', document.querySelector('.nav-button'));
                                this.showEditMode();
                                this.editQuestion(questionIndex);
                            }
                        });

                    // 收藏模式删除题目按钮
                    document.getElementById('deleteFavoriteQuestionButton').addEventListener('click',
                        () => {
                            const library = this.getCurrentLibrary();
                            const questionIndex = library.favoriteQuestions[library.favoriteMode.currentIndex];

                            if (confirm('确定要删除这道题目吗？')) {
                                this.deleteQuestion(questionIndex);
                                this.updateFavoriteModeUI();

                                // 退出编辑模式
                                this.editData.isEditing = false;
                                document.getElementById('editFavoriteQuestionButton').textContent = '编辑题目';
                                document.getElementById('deleteFavoriteQuestionButton').classList.add('hidden');
                            }
                        });
                },

                // 新增编辑相关数据
                editData: {
                    currentEditIndex: -1,
                    currentTab: 'questions',
                    images: {
                        question: null,
                        explanation: null
                    }
                },

                initEditMode() {
                    document.getElementById('editLibraryButton').addEventListener('click',
                        () => {
                            this.showEditMode();
                        });

                    // 添加退出编辑按钮
                    document.getElementById('cancelEditButton').addEventListener('click',
                        () => {
                            this.hideEditMode();
                        });

                    document.getElementById('question-image').addEventListener('change',
                        (e) => {
                            this.previewImage(e, 'question');
                        });

                    document.getElementById('explanation-image').addEventListener('change',
                        (e) => {
                            this.previewImage(e, 'explanation');
                        });

                    document.getElementById('questionSearchInput').addEventListener('keyup',
                        (e) => {
                            if (e.key === 'Enter') {
                                this.searchQuestions();
                            }
                        });
                },

                showEditMode() {
                    const library = this.getCurrentLibrary();
                    if (!library) {
                        alert('请先创建或导入题库');
                        return;
                    }

                    document.getElementById('edit-container').classList.remove('hidden');
                    this.updateQuestionList();

                    // 移除隐藏其他按钮的代码
                    // document.querySelector('.action-buttons').classList.add('hidden');

                    // 显示退出按钮
                    document.getElementById('cancelEditButton').classList.remove('hidden');
                },

                hideEditMode() {
                    document.getElementById('edit-container').classList.add('hidden');
                    this.resetEditForm();

                    // 移除显示其他按钮的代码
                    // document.querySelector('.action-buttons').classList.remove('hidden');

                    // 隐藏退出按钮
                    document.getElementById('cancelEditButton').classList.add('hidden');
                },

                updateQuestionList() {
                    const library = this.getCurrentLibrary();
                    const questionList = document.getElementById('question-list');
                    questionList.innerHTML = '';

                    library.questions.forEach((question, index) => {
                        const item = document.createElement('div');
                        item.className = 'library-item';
                        item.style.marginBottom = '5px';
                        item.style.cursor = 'pointer';

                        const questionText = document.createElement('span');
                        questionText.textContent = `${index + 1}. ${question.题干.substring(0, 30)}${question.题干.length > 30 ? '...': ''}`;

                        const editBtn = document.createElement('button');
                        editBtn.className = 'button button-primary';
                        editBtn.textContent = '编辑';
                        editBtn.style.marginLeft = '10px';
                        editBtn.style.padding = '2px 8px';
                        editBtn.style.fontSize = '12px';
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.editQuestion(index);
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'button button-danger';
                        deleteBtn.textContent = '删除';
                        deleteBtn.style.marginLeft = '5px';
                        deleteBtn.style.padding = '2px 8px';
                        deleteBtn.style.fontSize = '12px';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.deleteQuestion(index);
                        });

                        item.appendChild(questionText);
                        item.appendChild(editBtn);
                        item.appendChild(deleteBtn);

                        item.addEventListener('click', () => {
                            this.editQuestion(index);
                        });

                        questionList.appendChild(item);
                    });
                },

                editQuestion: function(index) {
                    const library = this.getCurrentLibrary();
                    const question = library.questions[index];

                    this.editData.currentEditIndex = index;
                    this.switchEditTab('edit');

                    // 填充表单
                    document.getElementById('edit-question').value = question.题干;
                    document.getElementById('edit-type').value = question.类型;
                    document.getElementById('edit-answer').value = question.答案;
                    document.getElementById('edit-explanation').value = question.解析 || '';

                    // 根据题型设置表单
                    const optionsContainer = document.getElementById('edit-options-container');
                    if (question.类型 === '填空' || question.类型 === '简答') {
                        optionsContainer.style.display = 'none';
                        if (question.类型 === '填空') {
                            document.getElementById('edit-answer').type = 'text';
                            document.getElementById('edit-answer').placeholder = '请输入正确答案（多个答案用|分隔）';
                        } else {
                            document.getElementById('edit-answer').type = 'textarea';
                            document.getElementById('edit-answer').placeholder = '请输入参考答案';
                        }
                    } else {
                        optionsContainer.style.display = 'block';
                        document.getElementById('edit-answer').type = 'text';
                        document.getElementById('edit-answer').placeholder = '如A或AB';

                        // 清空选项容器
                        optionsContainer.innerHTML = '';

                        // 查找所有存在的选项
                        const existingOptions = [];
                        const optionLetters = ['A',
                            'B',
                            'C',
                            'D',
                            'E',
                            'F',
                            'G',
                            'H'];
                        optionLetters.forEach(letter => {
                            if (question[`选项${letter}`] || question[`选项${letter}Image`]) {
                                existingOptions.push({
                                    letter: letter,
                                    text: question[`选项${letter}`] || '',
                                    image: question[`选项${letter}Image`] || null
                                });
                            }
                        });

                        // 如果有选项，加载它们；否则添加默认的A-E选项
                        if (existingOptions.length > 0) {
                            existingOptions.forEach(opt => {
                                this.addOption(opt.letter, opt.text, opt.image);
                            });
                        } else {
                            // 默认添加A-E选项
                            ['A',
                                'B',
                                'C',
                                'D',
                                'E'].forEach(letter => {
                                    this.addOption(letter, '', null);
                                });
                        }
                    }
                },

                submitTextAnswer: function(userAnswer, questionType) {
                    const currentQuestion = this.getCurrentQuestion(false);
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    // 保存用户答案
                    userAnswers[currentIndex] = {
                        selected: userAnswer,
                        isCorrect: this.checkTextAnswer(userAnswer, currentQuestion.答案, questionType),
                        isSubmitted: true
                    };

                    // 如果回答错误，添加到错题本
                    if (!userAnswers[currentIndex].isCorrect) {
                        this.addToWrongQuestions(currentIndex);
                    }

                    this.saveToStorage();
                    this.updateOptionStyles(false);

                    // 显示结果
                    const resultDiv = document.getElementById('answer-result');
                    if (userAnswers[currentIndex].isCorrect) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = questionType === '填空' ?
                        `回答错误，正确答案是 ${currentQuestion.答案}`:
                        '回答不完全正确，请参考解析';
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    // 显示答案和解析
                    document.getElementById('correct-answer').textContent = currentQuestion.答案;
                    document.getElementById('explanation').textContent = currentQuestion.解析 || '暂无解析';
                    document.getElementById('answer-container').classList.remove('hidden');
                    document.getElementById('explanation-container').classList.remove('hidden');
                },

                checkTextAnswer: function(userAnswer, correctAnswer, questionType) {
                    if (!userAnswer || !correctAnswer) return false;

                    if (questionType === '填空') {
                        // 处理多个填空的情况
                        const userAnswers = userAnswer.split('|').map(a => a.trim());
                        const correctAnswers = correctAnswer.split('|').map(a => a.trim());

                        // 确保答案数量相同
                        if (userAnswers.length !== correctAnswers.length) return false;

                        // 检查每个答案
                        return userAnswers.every((ans, i) =>
                            ans.toLowerCase() === correctAnswers[i].toLowerCase()
                        );
                    } else {
                        // 简答题可以只检查关键词或进行模糊匹配
                        // 这里简单实现完全匹配
                        return userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    }
                },

                addOption(letter = null, text = '', image = null) {
                    const optionsContainer = document.getElementById('edit-options-container');
                    const optionLetters = ['A',
                        'B',
                        'C',
                        'D',
                        'E',
                        'F',
                        'G',
                        'H'];

                    // 如果没有指定字母，自动分配下一个可用的字母
                    if (!letter) {
                        const existingLetters = Array.from(optionsContainer.querySelectorAll('.edit-option'))
                        .map(opt => opt.querySelector('select').value);

                        for (let l of optionLetters) {
                            if (!existingLetters.includes(l)) {
                                letter = l;
                                break;
                            }
                        }

                        if (!letter) {
                            alert('选项数量已达上限');
                            return;
                        }
                    }

                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'edit-option';

                    // 第一行：字母选择和文本输入
                    const optionRow1 = document.createElement('div');
                    optionRow1.className = 'edit-option-row';

                    // 选项字母选择
                    const letterSelect = document.createElement('select');
                    letterSelect.style.marginRight = '10px';
                    optionLetters.forEach(l => {
                        const option = document.createElement('option');
                        option.value = l;
                        option.textContent = l;
                        letterSelect.appendChild(option);
                    });
                    letterSelect.value = letter;

                    // 选项内容输入框
                    const textInput = document.createElement('textarea'); // 改为textarea以便调整高度
                    textInput.placeholder = '选项内容';
                    textInput.value = text;
                    textInput.style.flex = '1';
                    textInput.style.minHeight = '40px';
                    textInput.style.minWidth = '200px';
                    textInput.style.resize = 'both';

                    optionRow1.appendChild(letterSelect);
                    optionRow1.appendChild(textInput);

                    // 第二行：操作按钮
                    const optionRow2 = document.createElement('div');
                    optionRow2.className = 'edit-option-actions';

                    // 图片上传按钮
                    const uploadBtn = document.createElement('button');
                    uploadBtn.type = 'button';
                    uploadBtn.textContent = '上传图片';
                    uploadBtn.className = 'button button-primary';
                    uploadBtn.style.padding = '5px 10px';

                    // 删除图片按钮
                    const removeImageBtn = document.createElement('button');
                    removeImageBtn.type = 'button';
                    removeImageBtn.textContent = '删除图片';
                    removeImageBtn.className = 'button button-danger';
                    removeImageBtn.style.padding = '5px 10px';
                    removeImageBtn.style.display = 'none';

                    // 删除选项按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.textContent = '删除选项';
                    deleteBtn.className = 'button button-danger';
                    deleteBtn.style.padding = '5px 10px';

                    // 图片预览
                    const imagePreview = document.createElement('img');
                    imagePreview.className = 'image-preview';
                    imagePreview.style.display = image ? 'block': 'none';
                    if (image) {
                        imagePreview.src = image;
                    }

                    // 图片上传处理
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.style.display = 'none';

                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                imagePreview.src = event.target.result;
                                imagePreview.style.display = 'block';
                                removeImageBtn.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        }
                    });

                    uploadBtn.addEventListener('click',
                        () => {
                            fileInput.click();
                        });

                    removeImageBtn.addEventListener('click',
                        () => {
                            imagePreview.src = '';
                            imagePreview.style.display = 'none';
                            removeImageBtn.style.display = 'none';
                            fileInput.value = '';
                        });

                    deleteBtn.addEventListener('click',
                        () => {
                            optionsContainer.removeChild(optionDiv);
                        });

                    // 组装第二行
                    optionRow2.appendChild(uploadBtn);
                    optionRow2.appendChild(removeImageBtn);
                    optionRow2.appendChild(deleteBtn);

                    // 组装整个选项
                    optionDiv.appendChild(optionRow1);
                    optionDiv.appendChild(optionRow2);
                    optionDiv.appendChild(fileInput);
                    optionDiv.appendChild(imagePreview);

                    optionsContainer.appendChild(optionDiv);
                },

                cancelEdit() {
                    this.switchEditTab('questions');
                    this.resetEditForm();
                },

                resetEditForm() {
                    this.editData.currentEditIndex = -1;
                    this.editData.images = {
                        question: null,
                        explanation: null
                    };

                    document.getElementById('edit-question').value = '';
                    document.getElementById('edit-type').value = '单选';
                    document.getElementById('edit-answer').value = '';
                    document.getElementById('edit-explanation').value = '';
                    document.getElementById('edit-options-container').innerHTML = '';

                    document.getElementById('question-image-preview').src = '';
                    document.getElementById('question-image-preview').classList.add('hidden');
                    document.getElementById('explanation-image-preview').src = '';
                    document.getElementById('explanation-image-preview').classList.add('hidden');

                    document.querySelectorAll('.image-upload button.button-danger').forEach(btn => {
                        btn.classList.add('hidden');
                    });
                },

                switchEditTab(tab) {
                    this.editData.currentTab = tab;

                    document.querySelectorAll('.edit-tab').forEach(t => {
                        t.classList.remove('active');
                    });

                    document.querySelectorAll('.edit-tab-content').forEach(c => {
                        c.classList.remove('active');
                    });

                    document.querySelector(`.edit-tab[onclick="quizApp.switchEditTab('${tab}')"]`).classList.add('active');
                    document.getElementById(`${tab}-tab`).classList.add('active');
                },

                uploadImage(type) {
                    const input = document.getElementById(`${type}-image`);
                    input.click();

                    input.addEventListener('change',
                        (e) => {
                            const file = e.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.editData.images[type] = e.target.result;
                                this.updateImagePreview(type);
                            };
                            reader.readAsDataURL(file);
                        });
                },
                previewImage(event,
                    type) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.editData.images[type] = e.target.result;
                        this.updateImagePreview(type);
                    };
                    reader.readAsDataURL(file);
                },

                updateImagePreview(type) {
                    const preview = document.getElementById(`${type}-image-preview`);
                    const removeBtn = document.querySelector(`button[onclick="quizApp.removeImage('${type}')"]`);

                    if (this.editData.images[type]) {
                        preview.src = this.editData.images[type];
                        preview.classList.remove('hidden');
                        removeBtn.classList.remove('hidden');
                    } else {
                        preview.src = '';
                        preview.classList.add('hidden');
                        removeBtn.classList.add('hidden');
                    }
                },

                removeImage(type) {
                    this.editData.images[type] = null;
                    document.getElementById(`${type}-image`).value = '';
                    this.updateImagePreview(type);
                },

                removeOptionImage(letter) {
                    const preview = document.querySelector(`img[data-option="${letter}"]`);
                    const removeBtn = document.querySelector(`button[data-option="${letter}"]`);

                    preview.src = '';
                    preview.classList.add('hidden');
                    removeBtn.classList.add('hidden');

                    // 清除文件输入的值
                    const input = preview.previousElementSibling;
                    while (input && input.tagName !== 'INPUT') {
                        input = input.previousElementSibling;
                    }
                    if (input) input.value = '';
                },

                showCreateLibraryDialog() {
                    const name = prompt("请输入新题库的名称:");
                    if (name && name.trim()) {
                        this.createNewLibrary(name.trim());
                    }
                },

                setupEventListeners() {
                    document.getElementById('importButton').addEventListener('click', () => {
                        document.getElementById('fileInput').click();
                    });

                    document.getElementById('fileInput').addEventListener('change', (e) => {
                        this.importLibrary(e.target.files[0]);
                        e.target.value = '';
                    });

                    document.getElementById('deleteLibraryButton').addEventListener('click', () => {
                        this.deleteCurrentLibrary();
                    });

                    document.getElementById('resetLibraryButton').addEventListener('click', () => {
                        this.resetCurrentLibrary();
                    });

                    // 练习模式事件
                    document.getElementById('shuffleButton').addEventListener('click', () => {
                        this.toggleShuffleMode(false);
                    });

                    document.getElementById('resetPracticeButton').addEventListener('click', () => {
                        this.resetPracticeMode();
                    });

                    document.getElementById('jumpButton').addEventListener('click', () => {
                        this.jumpToQuestion(false);
                    });

                    document.getElementById('prevButton').addEventListener('click', () => {
                        this.prevQuestion(false);
                    });

                    document.getElementById('nextButton').addEventListener('click', () => {
                        this.nextQuestion(false);
                    });

                    // 背题模式事件
                    document.getElementById('back-shuffleButton').addEventListener('click', () => {
                        this.toggleShuffleMode(true);
                    });

                    document.getElementById('resetBackModeButton').addEventListener('click', () => {
                        this.resetBackMode();
                    });

                    document.getElementById('back-jumpButton').addEventListener('click', () => {
                        this.jumpToQuestion(true);
                    });

                    document.getElementById('back-prevButton').addEventListener('click', () => {
                        this.prevQuestion(true);
                    });

                    document.getElementById('back-nextButton').addEventListener('click', () => {
                        this.nextQuestion(true);
                    });

                    document.getElementById('exportButton').addEventListener('click', () => {
                        this.exportCurrentLibrary();
                    });

                    // 练习模式导出按钮
                    document.getElementById('exportPracticeButton').addEventListener('click', () => {
                        this.exportCurrentQuestions('practice');
                    });

                    // 错题本导出按钮
                    document.getElementById('exportWrongButton').addEventListener('click', () => {
                        this.exportCurrentQuestions('wrong');
                    });

                    // 收藏本导出按钮
                    document.getElementById('exportFavoriteButton').addEventListener('click', () => {
                        this.exportCurrentQuestions('favorite');
                    });
                },

                // 在quizApp对象中修改exportCurrentLibrary方法
                exportCurrentLibrary() {
                    const library = this.getCurrentLibrary();
                    if (!library || library.questions.length === 0) {
                        alert('当前题库为空，无法导出');
                        return;
                    }

                    // 准备导出数据
                    const exportData = library.questions.map(question => {
                        const row = {
                            '题干': question.题干,
                            '类型': question.类型,
                            '答案': question.答案,
                            '解析': question.解析 || ''
                        };

                        // 添加选项
                        const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                        optionLetters.forEach(letter => {
                            if (question[`选项${letter}`]) {
                                row[`选项${letter}`] = question[`选项${letter}`];
                            }
                        });

                        return row;
                    });

                    // 创建JSON字符串用于复制
                    const jsonStr = JSON.stringify({
                        name: library.name || '未命名题库',
                        questions: exportData
                    }, null, 2);

                    // 创建Excel文件用于下载
                    const worksheet = XLSX.utils.json_to_sheet(exportData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "题库");
                    const excelBuffer = XLSX.write(workbook, {
                        bookType: 'xlsx', type: 'array'
                    });

                    // 显示导出选项对话框
                    this.showExportOptions(jsonStr, excelBuffer, library.name || '未命名题库');
                },

                // 新增方法：显示导出选项对话框
                showExportOptions(jsonStr, excelBuffer, libraryName) {
                    // 创建对话框容器
                    const container = document.createElement('div');
                    container.style.position = 'fixed';
                    container.style.top = '50%';
                    container.style.left = '50%';
                    container.style.transform = 'translate(-50%, -50%)';
                    container.style.backgroundColor = 'white';
                    container.style.padding = '20px';
                    container.style.borderRadius = '5px';
                    container.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                    container.style.zIndex = '1000';
                    container.style.maxWidth = '90%';
                    container.style.maxHeight = '90vh';
                    container.style.overflow = 'auto';
                    container.style.textAlign = 'center';

                    // 添加标题
                    const title = document.createElement('h3');
                    title.textContent = '导出选项';
                    title.style.marginBottom = '15px';
                    container.appendChild(title);

                    // 创建按钮容器
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.flexDirection = 'column';
                    buttonContainer.style.gap = '10px';
                    buttonContainer.style.marginTop = '15px';

                    // 创建下载Excel按钮
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = '下载Excel文件';
                    downloadButton.className = 'button button-primary';
                    downloadButton.addEventListener('click', () => {
                        this.downloadExcel(excelBuffer,
                            libraryName);
                        document.body.removeChild(container);
                    });
                    buttonContainer.appendChild(downloadButton);

                    // 创建复制JSON按钮
                    const copyButton = document.createElement('button');
                    copyButton.textContent = '复制JSON内容';
                    copyButton.className = 'button button-success';
                    copyButton.addEventListener('click', () => {
                        this.copyJsonContent(jsonStr,
                            copyButton);
                    });
                    buttonContainer.appendChild(copyButton);

                    // 创建关闭按钮
                    const closeButton = document.createElement('button');
                    closeButton.textContent = '取消';
                    closeButton.className = 'button button-danger';
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(container);
                    });
                    buttonContainer.appendChild(closeButton);

                    container.appendChild(buttonContainer);
                    document.body.appendChild(container);
                },

                // 新增方法：下载Excel文件
                downloadExcel(excelBuffer, libraryName) {
                    const data = new Blob([excelBuffer], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    const url = URL.createObjectURL(data);

                    const link = document.getElementById('downloadLink');
                    link.href = url;
                    link.download = `${libraryName || '题库导出'}.xlsx`;
                    link.click();

                    // 清理URL对象
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                },

                // 修改后的复制JSON方法
                copyJsonContent(jsonStr, button) {
                    const textarea = document.createElement('textarea');
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    textarea.style.top = '-9999px';
                    textarea.value = jsonStr;
                    document.body.appendChild(textarea);

                    try {
                        textarea.select();
                        const successful = document.execCommand('copy');

                        if (successful) {
                            // 显示复制成功反馈
                            const originalText = button.textContent;
                            button.textContent = '复制成功!';
                            button.className = 'button button-success';

                            setTimeout(() => {
                                button.textContent = originalText;
                                button.className = 'button button-success';
                            }, 2000);
                        } else {
                            alert('复制失败，请手动选择文本后按Ctrl+C');
                        }
                    } catch (err) {
                        alert('复制失败，请手动选择文本后按Ctrl+C');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                },

                // 显示复制成功的反馈
                showCopySuccess(button) {
                    const originalText = button.textContent;
                    button.textContent = '复制成功!';
                    button.className = 'button button-success';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'button button-primary';
                    }, 2000);
                },

                // 备用复制方法
                fallbackCopyText(textarea, button) {
                    try {
                        // 确保textarea可见（虽然我们设置为fixed定位）
                        textarea.style.position = 'fixed';
                        textarea.style.left = '0';
                        textarea.style.top = '0';
                        textarea.style.width = '2em';
                        textarea.style.height = '2em';
                        textarea.style.padding = '0';
                        textarea.style.border = 'none';
                        textarea.style.outline = 'none';
                        textarea.style.boxShadow = 'none';
                        textarea.style.background = 'transparent';

                        // 选中文本
                        textarea.select();
                        textarea.setSelectionRange(0, textarea.value.length);

                        // 执行复制命令
                        const successful = document.execCommand('copy');
                        if (successful) {
                            this.showCopySuccess(button);
                        } else {
                            button.textContent = '复制失败，请手动选择文本后按Ctrl+C';
                            button.className = 'button button-danger';
                        }
                    } catch (err) {
                        button.textContent = '复制失败，请手动选择文本后按Ctrl+C';
                        button.className = 'button button-danger';
                    } finally {
                        // 恢复textarea样式
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-9999px';
                        textarea.style.top = '-9999px';
                    }
                },


                setupWrongAndFavoriteListeners() {
                    // 错题本导航按钮
                    document.getElementById('wrong-jumpButton').addEventListener('click', () => {
                        this.jumpToQuestionInWrongMode();
                    });

                    document.getElementById('wrong-prevButton').addEventListener('click', () => {
                        this.prevQuestionInWrongMode();
                    });

                    document.getElementById('wrong-nextButton').addEventListener('click', () => {
                        this.nextQuestionInWrongMode();
                    });

                    document.getElementById('resetWrongModeButton').addEventListener('click', () => {
                        this.resetWrongMode();
                    });

                    document.getElementById('wrong-favorite-button').addEventListener('click', () => {
                        this.toggleFavoriteInWrongMode();
                    });

                    document.getElementById('wrong-remove-button').addEventListener('click', () => {
                        this.removeFromWrongMode();
                    });

                    // 收藏本导航按钮
                    document.getElementById('favorite-jumpButton').addEventListener('click', () => {
                        this.jumpToQuestionInFavoriteMode();
                    });

                    document.getElementById('favorite-prevButton').addEventListener('click', () => {
                        this.prevQuestionInFavoriteMode();
                    });

                    document.getElementById('favorite-nextButton').addEventListener('click', () => {
                        this.nextQuestionInFavoriteMode();
                    });

                    document.getElementById('resetFavoriteModeButton').addEventListener('click', () => {
                        this.resetFavoriteMode();
                    });

                    document.getElementById('favorite-remove-button').addEventListener('click', () => {
                        this.removeFromFavoriteMode();
                    });

                    document.getElementById('practiceWrongButton').addEventListener('click', () => {
                        this.toggleWrongPracticeMode();
                    });

                    // 练习模式收藏按钮
                    document.getElementById('favoriteButton').addEventListener('click', () => {
                        const library = this.getCurrentLibrary();
                        const mode = library.practiceMode;
                        const questionIndex = mode.isShuffled ?
                        mode.shuffledIndices[mode.currentIndex]:
                        mode.currentIndex;
                        const isFavorite = this.toggleFavoriteQuestion(questionIndex);
                        document.getElementById('favoriteButton').textContent = isFavorite ? '已收藏': '收藏本题';
                        document.getElementById('favoriteButton').className = 'button ' + (isFavorite ? 'button-success': 'button-warning');
                    });

                    // 背题模式收藏按钮
                    document.getElementById('back-favoriteButton').addEventListener('click', () => {
                        const library = this.getCurrentLibrary();
                        const mode = library.backMode;
                        const questionIndex = mode.isShuffled ?
                        mode.shuffledIndices[mode.currentIndex]:
                        mode.currentIndex;
                        const isFavorite = this.toggleFavoriteQuestion(questionIndex);
                        document.getElementById('back-favoriteButton').textContent = isFavorite ? '已收藏': '收藏本题';
                        document.getElementById('back-favoriteButton').className = 'button ' + (isFavorite ? 'button-success': 'button-warning');
                    });
                },

                setupSwipeGestures: function() {
                    let startX,
                    startY;
                    const container = document.querySelector('.container');

                    container.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                    }, false);

                    container.addEventListener('touchmove', (e) => {
                        if (!startX || !startY) return;

                        const diffX = startX - e.touches[0].clientX;
                        const diffY = startY - e.touches[0].clientY;

                        if (Math.abs(diffX) > Math.abs(diffY)) {
                            if (diffX > 50) {
                                // 向左滑动
                                this.handleSwipe('left');
                                startX = null;
                                startY = null;
                            } else if (diffX < -50) {
                                // 向右滑动
                                this.handleSwipe('right');
                                startX = null;
                                startY = null;
                            }
                        }
                    },
                        false);
                },

                handleSwipe: function(direction) {
                    // 检查是否在每题计时模式下，如果是则禁用滑动
                    const exam = this.examData.currentExam;
                    if (exam && exam.settings.examMode === 'timed') {
                        return;
                    }

                    const activePage = document.querySelector('.page.active').id;

                    if (activePage === 'exam-page') {
                        if (document.getElementById('exam-in-progress').classList.contains('hidden')) return;

                        if (direction === 'left') {
                            this.nextExamQuestion();
                        } else if (direction === 'right') {
                            this.prevExamQuestion();
                        }
                    }
                    if (activePage === 'practice-page') {
                        if (direction === 'left') {
                            this.nextQuestion(false);
                        } else if (direction === 'right') {
                            this.prevQuestion(false);
                        }
                    } else if (activePage === 'back-page') {
                        if (direction === 'left') {
                            this.nextQuestion(true);
                        } else if (direction === 'right') {
                            this.prevQuestion(true);
                        }
                    } else if (activePage === 'wrong-page') {
                        if (direction === 'left') {
                            this.nextQuestionInWrongMode();
                        } else if (direction === 'right') {
                            this.prevQuestionInWrongMode();
                        }
                    } else if (activePage === 'favorite-page') {
                        if (direction === 'left') {
                            this.nextQuestionInFavoriteMode();
                        } else if (direction === 'right') {
                            this.prevQuestionInFavoriteMode();
                        }
                    }
                },

                updateUI() {
                    this.updateLibraryList();
                    this.updatePracticeModeUI(false);
                    this.updateBackModeUI();
                },

                updateLibraryList() {
                    const libraryList = document.getElementById('library-list');
                    libraryList.innerHTML = '';

                    if (this.data.libraries.length === 0) {
                        libraryList.innerHTML = '<p>暂无题库，请导入题库</p>';
                        document.getElementById('sub-title').textContent = '';
                        return;
                    }

                    this.data.libraries.forEach((library, index) => {
                        const item = document.createElement('div');
                        item.className = `library-item ${index === this.data.currentLibraryIndex ? 'active': ''}`;
                        item.textContent = library.name || `题库 ${index + 1}`;
                        item.addEventListener('click', () => {
                            this.data.currentLibraryIndex = index;
                            this.saveToStorage();
                            this.updateUI();
                        });
                        libraryList.appendChild(item);
                    });

                    const currentLibrary = this.getCurrentLibrary();
                    document.getElementById('sub-title').textContent = currentLibrary.name || `题库 ${this.data.currentLibraryIndex + 1}`;
                },

                getCurrentLibrary() {
                    return this.data.libraries[this.data.currentLibraryIndex];
                },

                getCurrentQuestion(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    if (mode.isShuffled && mode.shuffledIndices.length > 0) {
                        return library.questions[mode.shuffledIndices[mode.currentIndex]];
                    } else {
                        return library.questions[mode.currentIndex];
                    }
                },

                getCurrentUserAnswers(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    return mode.isShuffled ? library.userAnswers.shuffled: library.userAnswers.ordered;
                },

                // 在生成随机题目时，确保共用题目一起出现
                generateShuffledIndices: function(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = isBackMode ? library.backMode: library.practiceMode;

                    // 先分组处理共用题目
                    const groupedQuestions = {};
                    library.questions.forEach((q, index) => {
                        if (q.groupId) {
                            if (!groupedQuestions[q.groupId]) {
                                groupedQuestions[q.groupId] = [];
                            }
                            groupedQuestions[q.groupId].push(index);
                        }
                    });

                    // 创建索引数组，共用题目作为一个整体
                    const individualIndices = [];
                    const groupIndices = [];

                    // 分离独立题目和共用题目组
                    library.questions.forEach((q, index) => {
                        if (!q.groupId) {
                            individualIndices.push(index);
                        }
                    });

                    for (const groupId in groupedQuestions) {
                        groupIndices.push(groupedQuestions[groupId]);
                    }

                    // 打乱顺序
                    const shuffledIndividual = [...individualIndices].sort(() => 0.5 - Math.random());
                    const shuffledGroups = [...groupIndices].sort(() => 0.5 - Math.random());

                    // 合并结果
                    mode.shuffledIndices = [];

                    // 先添加独立题目
                    shuffledIndividual.forEach(index => {
                        mode.shuffledIndices.push(index);
                    });

                    // 再添加共用题目组
                    shuffledGroups.forEach(group => {
                        group.forEach(index => {
                            mode.shuffledIndices.push(index);
                        });
                    });

                    mode.currentIndex = 0;
                },

                updatePracticeModeUI: function(isBackMode) {
                    const library = this.getCurrentLibrary();
                    const mode = library.practiceMode;
                    const currentQuestion = this.getCurrentQuestion(false);

                    if (!currentQuestion) {
                        document.getElementById('question-container').innerHTML = '<p>暂无题目</p>';
                        return;
                    }

                    // 更新状态信息
                    document.getElementById('status-info').textContent =
                    `${mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1}/${library.questions.length}`;

                    // 更新进度条
                    document.getElementById('progress').style.width =
                    `${((mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1) / library.questions.length) * 100}%`;

                    // 更新题目（支持图片）
                    document.getElementById('question').innerHTML =
                    `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">${
                    currentQuestion.类型 === '单选' ? '单选题':
                    currentQuestion.类型 === '多选' ? '多选题':
                    currentQuestion.类型 === '填空' ? '填空题': '简答题'
                    }</div>
                    <span>${mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1}. </span>${this.renderQuestionWithImages(currentQuestion)}`;

                    // 更新选项或答案输入区域
                    const optionsContainer = document.getElementById('options');
                    optionsContainer.innerHTML = '';

                    const userAnswers = this.getCurrentUserAnswers(false);
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;
                    const userAnswer = userAnswers[currentIndex];

                    // 在updatePracticeModeUI函数中找到填空题处理部分，修改为：
                    if (currentQuestion.类型 === '填空') {
                        const fillContainer = document.createElement('div');
                        fillContainer.style.marginTop = '10px';

                        // 分割题干
                        const questionParts = currentQuestion.题干.split('[填空]');

                        // 获取用户已输入的答案（如果有）
                        const userAnswer = userAnswers[currentIndex] || {};
                        const userFilledAnswers = userAnswer.selected ?
                        userAnswer.selected.split('|').map(a => a.trim()):
                        Array(questionParts.length - 1).fill('');

                        // 构建填空题干，填充用户已输入的答案
                        questionParts.forEach((part, index) => {
                            fillContainer.appendChild(document.createTextNode(part));

                            if (index < questionParts.length - 1) {
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.className = 'fill-blank-input';
                                input.style.margin = '0 5px';
                                input.style.minWidth = '80px';
                                input.style.borderBottom = '1px solid #333';

                                // 恢复用户已输入的答案
                                if (userFilledAnswers[index] !== undefined) {
                                    input.value = userFilledAnswers[index];
                                }

                                // 如果已经提交过答案，设置为只读
                                if (userAnswer.isSubmitted) {
                                    input.readOnly = true;
                                    // 根据正确与否设置样式
                                    if (userAnswer.isCorrect !== undefined) {
                                        input.style.borderBottomColor = userAnswer.isCorrect ?
                                        'var(--correct-color)': 'var(--wrong-color)';
                                    }
                                }

                                // 实时保存用户输入
                                input.addEventListener('input', () => {
                                    if (!userAnswers[currentIndex]) {
                                        userAnswers[currentIndex] = {};
                                    }

                                    // 收集所有填空的答案
                                    const inputs = fillContainer.querySelectorAll('.fill-blank-input');
                                    const currentAnswers = Array.from(inputs).map(input => input.value.trim());
                                    userAnswers[currentIndex].selected = currentAnswers.join('|');

                                    this.saveToStorage();
                                });

                                fillContainer.appendChild(input);
                            }
                        });

                        optionsContainer.appendChild(fillContainer);

                        // 如果尚未提交，添加提交按钮
                        if (!userAnswer.isSubmitted) {
                            const submitButton = document.createElement('button');
                            submitButton.className = 'button button-primary';
                            submitButton.textContent = '提交答案';
                            submitButton.style.marginTop = '15px';
                            // 在提交按钮的点击事件处理中，确保这样保存答案：
                            submitButton.addEventListener('click', () => {
                                const inputs = fillContainer.querySelectorAll('.fill-blank-input');
                                const userAnswers = Array.from(inputs).map(input => input.value.trim());
                                const correctAnswers = currentQuestion.答案.split('|').map(a => a.trim());

                                // 检查答案是否正确
                                const isCorrect = userAnswers.length === correctAnswers.length &&
                                userAnswers.every((ans, i) => ans.toLowerCase() === correctAnswers[i].toLowerCase());

                                // 保存用户答案状态 - 这里确保使用正确的引用
                                const userAnswersRef = this.getCurrentUserAnswers(false);
                                if (!userAnswersRef[currentIndex]) {
                                    userAnswersRef[currentIndex] = {};
                                }
                                userAnswersRef[currentIndex] = {
                                    selected: userAnswers.join('|'),
                                    isSubmitted: true,
                                    isCorrect: isCorrect
                                };

                                this.saveToStorage();

                                // 更新UI - 显示结果
                                const resultDiv = document.getElementById('answer-result');
                                if (isCorrect) {
                                    resultDiv.textContent = '回答正确';
                                    resultDiv.style.color = 'var(--correct-color)';
                                } else {
                                    resultDiv.textContent = `回答错误，正确答案是 ${currentQuestion.答案}`;
                                    resultDiv.style.color = 'var(--wrong-color)';
                                }

                                // 显示正确答案和解析
                                document.getElementById('correct-answer').textContent = currentQuestion.答案;
                                document.getElementById('explanation').innerHTML = this.formatTextWithLineBreaks(currentQuestion.解析) || '暂无解析';
                                document.getElementById('answer-container').classList.remove('hidden');
                                document.getElementById('explanation-container').classList.remove('hidden');

                                // 设置为只读并更新样式
                                inputs.forEach(input => {
                                    input.readOnly = true;
                                    input.style.borderBottomColor = isCorrect ?
                                    'var(--correct-color)': 'var(--wrong-color)';
                                });

                                // 移除提交按钮
                                submitButton.remove();
                            });

                            optionsContainer.appendChild(submitButton);
                        } else {
                            // 如果已经提交过，显示结果
                            const resultDiv = document.getElementById('answer-result');
                            if (userAnswer.isCorrect) {
                                resultDiv.textContent = '回答正确';
                                resultDiv.style.color = 'var(--correct-color)';
                            } else {
                                resultDiv.textContent = `回答错误，正确答案是 ${currentQuestion.答案}`;
                                resultDiv.style.color = 'var(--wrong-color)';
                            }

                            // 显示正确答案和解析
                            document.getElementById('correct-answer').textContent = currentQuestion.答案;
                            document.getElementById('explanation').textContent = currentQuestion.解析 || '暂无解析';
                            document.getElementById('answer-container').classList.remove('hidden');
                            document.getElementById('explanation-container').classList.remove('hidden');
                        }
                    } else if (currentQuestion.类型 === '简答') {
                        // 简答题处理
                        const textarea = document.createElement('textarea');
                        textarea.className = 'form-input';
                        textarea.placeholder = '请输入简要回答';
                        textarea.style.minHeight = '100px';
                        textarea.style.marginTop = '10px';

                        if (userAnswer && userAnswer.selected) {
                            textarea.value = userAnswer.selected;
                        }

                        textarea.addEventListener('input', () => {
                            if (!userAnswers[currentIndex]) {
                                userAnswers[currentIndex] = {};
                            }
                            userAnswers[currentIndex].selected = textarea.value;
                            this.saveToStorage();
                        });

                        optionsContainer.appendChild(textarea);

                        // 添加提交按钮
                        const submitButton = document.createElement('button');
                        submitButton.className = 'button button-primary';
                        submitButton.textContent = '提交答案';
                        submitButton.style.marginTop = '15px';
                        submitButton.addEventListener('click',
                            () => {
                                if (!userAnswers[currentIndex]) {
                                    userAnswers[currentIndex] = {};
                                }
                                userAnswers[currentIndex].selected = textarea.value;
                                userAnswers[currentIndex].isSubmitted = true;
                                // 简答题不自动判断对错
                                userAnswers[currentIndex].isCorrect = false;

                                this.saveToStorage();
                                this.updatePracticeModeUI(false);
                            });

                        optionsContainer.appendChild(submitButton);
                    } else {
                        // 选择题处理（单选/多选）
                        const optionLetters = ['A',
                            'B',
                            'C',
                            'D',
                            'E',
                            'F',
                            'G',
                            'H'];
                        optionLetters.forEach(letter => {
                            if (currentQuestion[`选项${letter}`] || currentQuestion[`选项${letter}Image`]) {
                                const option = document.createElement('div');
                                option.className = 'option';

                                const optionLetter = document.createElement('span');
                                optionLetter.className = 'option-letter';
                                optionLetter.textContent = letter;

                                const optionText = document.createElement('span');
                                optionText.innerHTML = this.renderOptionWithImages(letter, currentQuestion);

                                option.appendChild(optionLetter);
                                option.appendChild(optionText);

                                if (currentQuestion.类型 === '多选') {
                                    option.addEventListener('click', () => {
                                        this.toggleMultiSelectOption(letter);
                                    });
                                } else {
                                    option.addEventListener('click', () => {
                                        this.selectOption(letter);
                                    });
                                }

                                optionsContainer.appendChild(option);
                            }
                        });

                        // 添加多选题提交按钮
                        if (currentQuestion.类型 === '多选') {
                            if (!userAnswer || !userAnswer.isSubmitted) {
                                const submitButton = document.createElement('button');
                                submitButton.id = 'multi-submit-btn';
                                submitButton.className = 'button button-primary';
                                submitButton.textContent = '提交答案';
                                submitButton.style.marginTop = '15px';
                                submitButton.addEventListener('click', () => {
                                    this.submitMultiSelectAnswer();
                                });
                                optionsContainer.appendChild(submitButton);
                            }
                        }
                    }

                    // 更新答案和解析（支持图片）
                    document.getElementById('correct-answer').textContent = currentQuestion.答案;

                    let explanation = this.formatTextWithLineBreaks(currentQuestion.解析) || '暂无解析';
                    if (currentQuestion.explanationImage) {
                        explanation += this.renderImage(currentQuestion.explanationImage, 'explanation-image');
                    }
                    document.getElementById('explanation').innerHTML = explanation;

                    // 更新跳转输入框
                    document.getElementById('jumpInput').value =
                    mode.isShuffled ? (mode.shuffledIndices[mode.currentIndex] + 1): (mode.currentIndex + 1);

                    // 更新按钮状态
                    document.getElementById('shuffleButton').textContent =
                    mode.isShuffled ? '顺序练习': '随机练习';

                    // 显示或隐藏答案区域
                    const answerResult = document.getElementById('answer-result');
                    const answerContainer = document.getElementById('answer-container');
                    const explanationContainer = document.getElementById('explanation-container');



                    if (userAnswer && userAnswer.isSubmitted) {
                        answerContainer.classList.remove('hidden');
                        explanationContainer.classList.remove('hidden');

                        if (userAnswer.isCorrect) {
                            answerResult.textContent = '回答正确';
                            answerResult.style.color = 'var(--correct-color)';
                        } else {
                            answerResult.textContent = currentQuestion.类型 === '填空' ?
                            `回答错误，正确答案是 ${currentQuestion.答案}`:
                            currentQuestion.类型 === '简答' ? '已提交答案，请参考解析':
                            `回答错误，你的答案是 ${userAnswer.selected}`;
                            answerResult.style.color = 'var(--wrong-color)';
                        }

                        // 标记正确和错误选项（仅选择题）
                        if (currentQuestion.类型 === '单选' || currentQuestion.类型 === '多选') {
                            const options = optionsContainer.querySelectorAll('.option');
                            options.forEach(option => {
                                const letter = option.querySelector('.option-letter').textContent;

                                if (currentQuestion.答案.includes(letter)) {
                                    option.classList.add('correct-answer');
                                } else if (userAnswer.selected === letter ||
                                    (currentQuestion.类型 === '多选' && userAnswer.selected.includes(letter))) {
                                    option.classList.add('wrong-answer');
                                }
                            });
                        }
                    } else {
                        answerContainer.classList.add('hidden');
                        explanationContainer.classList.add('hidden');
                        answerResult.textContent = '';
                    }

                    // 更新导航中的收藏按钮
                    const isFavorite = this.isQuestionFavorite(mode.isShuffled ? mode.shuffledIndices[mode.currentIndex]: mode.currentIndex);
                    document.getElementById('favoriteButton').textContent = isFavorite ? '已收藏': '收藏本题';
                    document.getElementById('favoriteButton').className = 'button ' + (isFavorite ? 'button-success': 'button-warning');
                },

                updateBackModeUI: function() {
                    const library = this.getCurrentLibrary();
                    if (!library || !library.questions || library.questions.length === 0) {
                        document.getElementById('back-question-container').innerHTML = '<p>请先导入题库</p>';
                        document.getElementById('back-status-info').textContent = '0/0';
                        document.getElementById('back-progress').style.width = '0%';
                        return;
                    }

                    const mode = library.backMode;
                    const currentQuestion = this.getCurrentQuestion(true);

                    if (!currentQuestion) {
                        document.getElementById('back-question-container').innerHTML = '<p>暂无题目</p>';
                        return;
                    }

                    // 更新状态信息
                    document.getElementById('back-status-info').textContent =
                    `${mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1}/${library.questions.length}`;

                    // 更新进度条
                    document.getElementById('back-progress').style.width =
                    `${((mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1) / library.questions.length) * 100}%`;

                    // 更新题目（支持图片）
                    const questionElement = document.getElementById('back-question');
                    questionElement.innerHTML =
                    `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">${
                    currentQuestion.类型 === '单选' ? '单选题':
                    currentQuestion.类型 === '多选' ? '多选题':
                    currentQuestion.类型 === '填空' ? '填空题': '简答题'
                    }</div>
                    <span>${mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1}. </span>${this.renderQuestionWithImages(currentQuestion)}`;

                    // 更新选项或答案显示区域
                    const optionsContainer = document.getElementById('back-options');
                    optionsContainer.innerHTML = '';

                    if (currentQuestion.类型 === '填空') {
                        // 填空题处理 - 显示正确答案
                        const answers = currentQuestion.答案.split('|').map(a => a.trim());
                        const questionParts = currentQuestion.题干.split('[填空]');

                        let filledQuestion = '';
                        questionParts.forEach((part, index) => {
                            filledQuestion += part;
                            if (index < answers.length) {
                                filledQuestion += `<span style="color: var(--correct-color); font-weight: bold;">${answers[index]}</span>`;
                            }
                        });

                        questionElement.innerHTML =
                        `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">填空题</div>
                        <span>${mode.isShuffled ? mode.currentIndex + 1: mode.currentIndex + 1}. </span>${filledQuestion}`;
                    } else if (currentQuestion.类型 === '简答') {
                        // 简答题处理 - 显示参考答案
                        const answerDisplay = document.createElement('div');
                        answerDisplay.className = 'answer-display';
                        answerDisplay.innerHTML = `<strong>参考答案：</strong>${currentQuestion.答案}`;
                        optionsContainer.appendChild(answerDisplay);
                    } else {
                        // 选择题处理（单选/多选）
                        const optionLetters = ['A',
                            'B',
                            'C',
                            'D',
                            'E',
                            'F',
                            'G',
                            'H'];
                        optionLetters.forEach(letter => {
                            if (currentQuestion[`选项${letter}`] || currentQuestion[`选项${letter}Image`]) {
                                const option = document.createElement('div');
                                option.className = 'option back-mode-option';

                                const optionLetter = document.createElement('span');
                                optionLetter.className = 'option-letter';
                                optionLetter.textContent = letter;

                                const optionText = document.createElement('span');
                                optionText.innerHTML = this.renderOptionWithImages(letter, currentQuestion);

                                option.appendChild(optionLetter);
                                option.appendChild(optionText);

                                // 标记正确答案
                                if (currentQuestion.答案.includes(letter)) {
                                    option.classList.add('correct-answer');
                                }

                                // 完全禁用点击事件
                                option.onclick = null;
                                option.style.pointerEvents = 'none';
                                option.style.cursor = 'default';

                                optionsContainer.appendChild(option);
                            }
                        });
                    }

                    // 更新答案和解析的显示状态（支持图片）
                    const answerContainer = document.getElementById('back-answer-container');
                    answerContainer.innerHTML = `<strong>正确答案：</strong>${currentQuestion.答案}`;

                    const explanationContainer = document.getElementById('back-explanation-container');
                    let explanation = this.formatTextWithLineBreaks(currentQuestion.解析) || '暂无解析';
                    if (currentQuestion.explanationImage) {
                        explanation += this.renderImage(currentQuestion.explanationImage, 'explanation-image');
                    }
                    explanationContainer.innerHTML = `<strong>解析：</strong>${explanation}`;

                    // 更新跳转输入框
                    document.getElementById('back-jumpInput').value =
                    mode.isShuffled ? (mode.shuffledIndices[mode.currentIndex] + 1): (mode.currentIndex + 1);

                    // 更新按钮状态
                    document.getElementById('back-shuffleButton').textContent =
                    mode.isShuffled ? '顺序背题': '随机背题';

                    // 更新收藏按钮状态
                    const backIsFavorite = this.isQuestionFavorite(mode.isShuffled ? mode.shuffledIndices[mode.currentIndex]: mode.currentIndex);
                    document.getElementById('back-favoriteButton').textContent = backIsFavorite ? '已收藏': '收藏本题';
                    document.getElementById('back-favoriteButton').className = 'button ' + (backIsFavorite ? 'button-success': 'button-warning');

                    // 确保所有选项都没有交互效果
                    const options = optionsContainer.querySelectorAll('.option');
                    options.forEach(option => {
                        option.onclick = null;
                        option.style.pointerEvents = 'none';
                        option.style.cursor = 'default';
                    });
                },

                selectOption(optionLetter) {
                    const currentQuestion = this.getCurrentQuestion(false);
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    // 如果是多选题，不在这里处理
                    if (currentQuestion.类型 === '多选') return;

                    // 保存当前选择（每次点击都视为提交）
                    userAnswers[currentIndex] = {
                        selected: optionLetter,
                        isCorrect: optionLetter === currentQuestion.答案,
                        isSubmitted: true
                    };

                    // 如果回答错误，添加到错题本
                    if (optionLetter !== currentQuestion.答案) {
                        this.addToWrongQuestions(currentIndex);
                        // 如果当前在错题本页面，更新UI
                        if (document.querySelector('.page.active').id === 'wrong-page') {
                            this.updateWrongModeUI();
                        }
                    }

                    this.saveToStorage();
                    this.updateOptionStyles(false);

                    // 显示结果和解析
                    const resultDiv = document.getElementById('answer-result');
                    if (optionLetter === currentQuestion.答案) {
                        resultDiv.textContent = '回答正确';
                        resultDiv.style.color = 'var(--correct-color)';
                    } else {
                        resultDiv.textContent = `回答错误，你的答案是 ${optionLetter}`;
                        resultDiv.style.color = 'var(--wrong-color)';
                    }

                    // 显示答案和解析
                    document.getElementById('correct-answer').textContent = currentQuestion.答案;
                    document.getElementById('explanation').textContent = currentQuestion.解析 || '暂无解析';
                    document.getElementById('answer-container').classList.remove('hidden');
                    document.getElementById('explanation-container').classList.remove('hidden');
                },

                updateOptionStyles: function(isBackMode) {
                    if (isBackMode) return;

                    const currentQuestion = this.getCurrentQuestion(false);
                    const userAnswers = this.getCurrentUserAnswers(false);
                    const mode = this.getCurrentLibrary().practiceMode;
                    const currentIndex = mode.isShuffled ?
                    mode.shuffledIndices[mode.currentIndex]:
                    mode.currentIndex;

                    const userAnswer = userAnswers[currentIndex];
                    const options = document.getElementById('options').querySelectorAll('.option');

                    options.forEach(option => {
                        const letter = option.querySelector('.option-letter').textContent;

                        // 移除所有样式类
                        option.classList.remove('selected-option', 'correct-answer', 'wrong-answer');

                        if (currentQuestion.类型 === '多选') {
                            // 多选题样式
                            if (userAnswer && userAnswer.selected.includes(letter)) {
                                option.classList.add('selected-option');
                            }

                            if (userAnswer && userAnswer.isSubmitted) {
                                if (currentQuestion.答案.includes(letter)) {
                                    option.classList.add('correct-answer');
                                } else if (userAnswer.selected.includes(letter)) {
                                    option.classList.add('wrong-answer');
                                }
                            }
                        } else if (currentQuestion.类型 === '单选') {
                            // 单选题样式
                            if (userAnswer && userAnswer.isSubmitted) {
                                // 用户选择的选项
                                if (userAnswer.selected === letter) {
                                    if (userAnswer.isCorrect) {
                                        option.classList.add('correct-answer');
                                    } else {
                                        option.classList.add('wrong-answer');
                                    }
                                }
                                // 正确答案（即使用户没选也要高亮）
                                if (currentQuestion.答案 === letter) {
                                    option.classList.add('correct-answer');
                                }
                            }
                        }
                    });

                    // 确保填空题的答案和解析在提交后保持显示
                    if (currentQuestion.类型 === '填空' && userAnswer && userAnswer.isSubmitted) {
                        document.getElementById('answer-container').classList.remove('hidden');
                        document.getElementById('explanation-container').classList.remove('hidden');
                    }
                },

                toggleWrongPracticeMode() {
                    const library = this.getCurrentLibrary();
                    if (!library.wrongPracticeMode) {
                        library.wrongPracticeMode = {
                            isActive: false,
                            userAnswers: {}
                        };
                    }

                    library.wrongPracticeMode.isActive = !library.wrongPracticeMode.isActive;
                    this.saveToStorage();
                    this.updateWrongModeUI();
                },

                isQuestionFavorite(questionIndex) {
                    const library = this.getCurrentLibrary();
                    return library.favoriteQuestions.includes(questionIndex);
                },

                // 错题本导航方法
                prevQuestionInWrongMode() {
                    const library = this.getCurrentLibrary();
                    if (library.wrongMode.currentIndex > 0) {
                        library.wrongMode.currentIndex--;
                        this.saveToStorage();
                        this.updateWrongModeUI();
                    } else {
                        alert('已经是第一题了');
                    }
                },

                nextQuestionInWrongMode() {
                    const library = this.getCurrentLibrary();
                    if (library.wrongMode.currentIndex < library.wrongQuestions.length - 1) {
                        library.wrongMode.currentIndex++;
                        this.saveToStorage();
                        this.updateWrongModeUI();
                    } else {
                        alert('已经是最后一题了');
                    }
                },

                jumpToQuestionInWrongMode() {
                    const input = document.getElementById('wrong-jumpInput');
                    const jumpTo = parseInt(input.value) - 1;
                    const library = this.getCurrentLibrary();

                    if (!isNaN(jumpTo) && jumpTo >= 0 && jumpTo < library.wrongQuestions.length) {
                        library.wrongMode.currentIndex = jumpTo;
                        this.saveToStorage();
                        this.updateWrongModeUI();
                    } else {
                        alert(`请输入1-${library.wrongQuestions.length}之间的有效题号`);
                        input.value = library.wrongMode.currentIndex + 1;
                    }
                },

                toggleFavoriteInWrongMode() {
                    const library = this.getCurrentLibrary();
                    const currentQuestionIndex = library.wrongQuestions[library.wrongMode.currentIndex];
                    const isFavorite = this.toggleFavoriteQuestion(currentQuestionIndex);

                    // 更新按钮状态
                    const favoriteButton = document.getElementById('wrong-favorite-button');
                    if (isFavorite) {
                        favoriteButton.textContent = '取消收藏';
                        favoriteButton.className = 'button button-success';
                    } else {
                        favoriteButton.textContent = '收藏本题';
                        favoriteButton.className = 'button button-warning';
                    }
                },

                removeFromWrongMode() {
                    const library = this.getCurrentLibrary();
                    const currentQuestionIndex = library.wrongQuestions[library.wrongMode.currentIndex];

                    if (confirm('确定要从错题本中移除这道题吗？')) {
                        // 从错题本中移除
                        const index = library.wrongQuestions.indexOf(currentQuestionIndex);
                        if (index !== -1) {
                            library.wrongQuestions.splice(index, 1);
                        }

                        // 调整当前索引
                        if (library.wrongMode.currentIndex >= library.wrongQuestions.length) {
                            library.wrongMode.currentIndex = Math.max(0, library.wrongQuestions.length - 1);
                        }

                        this.saveToStorage();
                        this.updateWrongModeUI();
                    }
                },

                // 收藏本导航方法
                prevQuestionInFavoriteMode() {
                    const library = this.getCurrentLibrary();
                    if (library.favoriteMode.currentIndex > 0) {
                        library.favoriteMode.currentIndex--;
                        this.saveToStorage();
                        this.updateFavoriteModeUI();
                    } else {
                        alert('已经是第一题了');
                    }
                },

                nextQuestionInFavoriteMode() {
                    const library = this.getCurrentLibrary();
                    if (library.favoriteMode.currentIndex < library.favoriteQuestions.length - 1) {
                        library.favoriteMode.currentIndex++;
                        this.saveToStorage();
                        this.updateFavoriteModeUI();
                    } else {
                        alert('已经是最后一题了');
                    }
                },

                jumpToQuestionInFavoriteMode() {
                    const input = document.getElementById('favorite-jumpInput');
                    const jumpTo = parseInt(input.value) - 1;
                    const library = this.getCurrentLibrary();

                    if (!isNaN(jumpTo) && jumpTo >= 0 && jumpTo < library.favoriteQuestions.length) {
                        library.favoriteMode.currentIndex = jumpTo;
                        this.saveToStorage();
                        this.updateFavoriteModeUI();
                    } else {
                        alert(`请输入1-${library.favoriteQuestions.length}之间的有效题号`);
                        input.value = library.favoriteMode.currentIndex + 1;
                    }
                },

                updateWrongModeUI() {
                    const library = this.getCurrentLibrary();

                    // 找到重置按钮部分
                    const resetButton = document.getElementById('resetWrongModeButton');
                    if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                        resetButton.textContent = '重置错题练习';
                    } else {
                        resetButton.textContent = '重置错题本';
                    }

                    // 更新练习按钮状态
                    const practiceButton = document.getElementById('practiceWrongButton');
                    if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                        practiceButton.textContent = '退出练习 (当前模式: 练习)';
                        practiceButton.className = 'button button-danger';
                    } else {
                        practiceButton.textContent = '练习错题 (当前模式: 浏览)';
                        practiceButton.className = 'button button-primary';
                    }

                    // 检查是否有题库
                    if (!library || !library.questions || library.questions.length === 0) {
                        document.getElementById('wrong-question-container').innerHTML = '<p>请先导入题库</p>';
                        document.getElementById('wrong-status-info').textContent = '0/0';
                        document.getElementById('wrong-progress').style.width = '0%';
                        return;
                    }

                    const wrongMode = library.wrongMode;
                    const wrongQuestions = library.wrongQuestions;

                    if (!wrongQuestions || wrongQuestions.length === 0) {
                        document.getElementById('wrong-question-container').innerHTML = '<p>暂无错题</p>';
                        document.getElementById('wrong-status-info').textContent = '0/0';
                        document.getElementById('wrong-progress').style.width = '0%';
                        return;
                    }

                    const currentQuestionIndex = wrongQuestions[wrongMode.currentIndex];
                    const currentQuestion = library.questions[currentQuestionIndex];

                    // 更新状态信息
                    document.getElementById('wrong-status-info').textContent =
                    `${wrongMode.currentIndex + 1}/${wrongQuestions.length}`;

                    // 更新进度条
                    document.getElementById('wrong-progress').style.width =
                    `${((wrongMode.currentIndex + 1) / wrongQuestions.length) * 100}%`;

                    // 更新题目（支持图片）
                    const questionElement = document.getElementById('wrong-question');
                    questionElement.innerHTML =
                    `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">${currentQuestion.类型 === '单选' ? '单选题': '多选题'}</div>
                    <span>${library.wrongMode.currentIndex + 1}. </span>${this.renderQuestionWithImages(currentQuestion)}`;

                    // 更新选项（支持图片）
                    const optionsContainer = document.getElementById('wrong-options');
                    optionsContainer.innerHTML = '';

                    const optionLetters = ['A',
                        'B',
                        'C',
                        'D',
                        'E',
                        'F',
                        'G',
                        'H'];
                    optionLetters.forEach(letter => {
                        if (currentQuestion[`选项${letter}`] || currentQuestion[`选项${letter}Image`]) {
                            const option = document.createElement('div');
                            option.className = 'option';

                            const optionLetter = document.createElement('span');
                            optionLetter.className = 'option-letter';
                            optionLetter.textContent = letter;

                            const optionText = document.createElement('span');
                            optionText.innerHTML = this.renderOptionWithImages(letter, currentQuestion);

                            option.appendChild(optionLetter);
                            option.appendChild(optionText);

                            // 在练习模式下添加点击事件
                            if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                                if (currentQuestion.类型 === '多选') {
                                    option.addEventListener('click', () => {
                                        this.toggleMultiSelectOptionInWrongMode(letter);
                                    });
                                } else {
                                    option.addEventListener('click', () => {
                                        this.selectOptionInWrongMode(letter);
                                    });
                                }

                                // 标记用户当前选择（仅在练习模式下）
                                const practiceAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];
                                if (practiceAnswer) {
                                    if (currentQuestion.类型 === '多选') {
                                        if (practiceAnswer.selected && practiceAnswer.selected.includes(letter)) {
                                            option.classList.add('selected-option');
                                        }
                                    } else {
                                        if (practiceAnswer.selected === letter) {
                                            option.classList.add('selected-option');
                                        }
                                    }
                                }
                            }

                            // 处理正确答案和错误答案的样式
                            if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                                const practiceAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];
                                if (practiceAnswer && practiceAnswer.isSubmitted) {
                                    // 正确答案总是显示为绿色
                                    if (currentQuestion.答案.includes(letter)) {
                                        option.classList.add('correct-answer');
                                        option.classList.remove('selected-option', 'wrong-answer');
                                    }
                                    // 用户选择的错误答案
                                    else if ((currentQuestion.类型 === '多选' && practiceAnswer.selected && practiceAnswer.selected.includes(letter)) ||
                                        (practiceAnswer.selected === letter)) {
                                        option.classList.add('wrong-answer');
                                        option.classList.remove('selected-option');
                                    }
                                }
                            } else {
                                // 浏览模式下显示所有答题痕迹
                                // 标记正确答案
                                if (currentQuestion.答案.includes(letter)) {
                                    option.classList.add('correct-answer');
                                }

                                // 标记用户错误答案（如果有）
                                const userAnswers = this.getCurrentUserAnswers(false);
                                const userAnswer = userAnswers[currentQuestionIndex];
                                if (userAnswer && userAnswer.isSubmitted) {
                                    if (currentQuestion.类型 === '多选') {
                                        if (userAnswer.selected && userAnswer.selected.includes(letter) && !currentQuestion.答案.includes(letter)) {
                                            option.classList.add('wrong-answer');
                                        }
                                    } else {
                                        if (userAnswer.selected === letter && userAnswer.selected !== currentQuestion.答案) {
                                            option.classList.add('wrong-answer');
                                        }
                                    }
                                }
                            }

                            optionsContainer.appendChild(option);
                        }
                    });

                    // 添加多选题提交按钮（练习模式下）
                    if (library.wrongPracticeMode && library.wrongPracticeMode.isActive &&
                        currentQuestion.类型 === '多选') {
                        const practiceAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];

                        if (!practiceAnswer || !practiceAnswer.isSubmitted) {
                            const submitButton = document.createElement('button');
                            submitButton.className = 'button button-primary';
                            submitButton.textContent = '提交答案';
                            submitButton.style.marginTop = '15px';
                            submitButton.addEventListener('click', () => {
                                this.submitMultiSelectAnswerInWrongMode();
                            });
                            optionsContainer.appendChild(submitButton);
                        }
                    }

                    // 更新答案和解析的显示状态（支持图片）
                    const answerContainer = document.getElementById('wrong-answer-container');
                    answerContainer.innerHTML = `<strong>正确答案：</strong>${currentQuestion.答案}`;

                    const explanationContainer = document.getElementById('wrong-explanation-container');
                    let explanation = this.formatTextWithLineBreaks(currentQuestion.解析) || '暂无解析';
                    if (currentQuestion.explanationImage) {
                        explanation += this.renderImage(currentQuestion.explanationImage, 'explanation-image');
                    }
                    explanationContainer.innerHTML = `<strong>解析：</strong>${explanation}`;

                    if (library.wrongPracticeMode && library.wrongPracticeMode.isActive) {
                        const practiceAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];
                        if (practiceAnswer && practiceAnswer.isSubmitted) {
                            answerContainer.classList.remove('hidden');
                            explanationContainer.classList.remove('hidden');
                        } else {
                            answerContainer.classList.add('hidden');
                            explanationContainer.classList.add('hidden');
                        }
                    } else {
                        // 非练习模式下始终显示答案和解析
                        answerContainer.classList.remove('hidden');
                        explanationContainer.classList.remove('hidden');
                    }

                    // 更新跳转输入框
                    document.getElementById('wrong-jumpInput').value = wrongMode.currentIndex + 1;

                    // 更新收藏按钮状态
                    const favoriteButton = document.getElementById('wrong-favorite-button');
                    if (this.isQuestionFavorite(currentQuestionIndex)) {
                        favoriteButton.textContent = '取消收藏';
                        favoriteButton.className = 'button button-success';
                    } else {
                        favoriteButton.textContent = '收藏本题';
                        favoriteButton.className = 'button button-warning';
                    }
                },

                exportCurrentQuestions(mode) {
                    const library = this.getCurrentLibrary();
                    let questionsToExport = [];
                    let exportName = '';

                    switch (mode) {
                        case 'practice':
                            const practiceMode = library.practiceMode;
                            if (practiceMode.isShuffled) {
                                questionsToExport = practiceMode.shuffledIndices.map(index => library.questions[index]);
                            } else {
                                questionsToExport = library.questions;
                            }
                            exportName = `${library.name || '未命名题库'}-练习模式`;
                            break;

                        case 'wrong':
                            questionsToExport = library.wrongQuestions.map(index => library.questions[index]);
                            exportName = `${library.name || '未命名题库'}-错题本`;
                            break;

                        case 'favorite':
                            questionsToExport = library.favoriteQuestions.map(index => library.questions[index]);
                            exportName = `${library.name || '未命名题库'}-收藏本`;
                            break;
                    }

                    if (questionsToExport.length === 0) {
                        alert('没有题目可导出');
                        return;
                    }

                    // 准备导出数据
                    const exportData = {
                        name: exportName,
                        questions: questionsToExport.map(question => {
                            const row = {
                                '题干': question.题干,
                                '类型': question.类型,
                                '答案': question.答案,
                                '解析': question.解析 || ''
                            };

                            // 添加选项
                            const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                            optionLetters.forEach(letter => {
                                if (question[`选项${letter}`]) {
                                    row[`选项${letter}`] = question[`选项${letter}`];
                                }
                                if (question[`选项${letter}Image`]) {
                                    row[`选项${letter}Image`] = question[`选项${letter}Image`];
                                }
                            });

                            // 添加题目图片和解析图片
                            if (question.questionImage) {
                                row['questionImage'] = question.questionImage;
                            }
                            if (question.explanationImage) {
                                row['explanationImage'] = question.explanationImage;
                            }

                            return row;
                        })
                    };

                    // 创建JSON字符串并显示复制界面
                    const jsonStr = JSON.stringify(exportData,
                        null,
                        2);
                    this.showExportDialog(jsonStr);
                },

                showExportDialog(jsonStr) {
                    // 创建JSON显示区域
                    const jsonDisplay = document.createElement('pre');
                    jsonDisplay.style.whiteSpace = 'pre-wrap';
                    jsonDisplay.style.padding = '10px';
                    jsonDisplay.style.backgroundColor = '#f5f5f5';
                    jsonDisplay.style.border = '1px solid #ddd';
                    jsonDisplay.style.maxHeight = '300px';
                    jsonDisplay.style.overflow = 'auto';
                    jsonDisplay.textContent = jsonStr;

                    // 创建隐藏的textarea用于复制
                    const textarea = document.createElement('textarea');
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    textarea.style.top = '-9999px';
                    textarea.value = jsonStr;
                    document.body.appendChild(textarea);

                    // 创建按钮容器
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.gap = '10px';
                    buttonContainer.style.marginTop = '10px';

                    // 创建复制按钮
                    const copyButton = document.createElement('button');
                    copyButton.textContent = '一键复制';
                    copyButton.className = 'button button-primary';
                    copyButton.addEventListener('click',
                        () => {
                            try {
                                // 现代浏览器方法
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(jsonStr).then(() => {
                                        this.showCopySuccess(copyButton);
                                    }).catch(() => {
                                        // 如果现代方法失败，使用备用方法
                                        this.fallbackCopyText(textarea, copyButton);
                                    });
                                } else {
                                    // 不支持clipboard API，使用备用方法
                                    this.fallbackCopyText(textarea, copyButton);
                                }
                            } catch (err) {
                                this.fallbackCopyText(textarea, copyButton);
                            }
                    });

                // 创建关闭按钮
                const closeButton = document.createElement('button');
                closeButton.textContent = '关闭';
                closeButton.className = 'button button-danger';
                closeButton.addEventListener('click',
                    () => {
                        document.body.removeChild(container);
                        document.body.removeChild(textarea);
                    });

                buttonContainer.appendChild(copyButton);
                buttonContainer.appendChild(closeButton);

                // 创建容器并添加元素
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '50%';
                container.style.left = '50%';
                container.style.transform = 'translate(-50%, -50%)';
                container.style.backgroundColor = 'white';
                container.style.padding = '20px';
                container.style.borderRadius = '5px';
                container.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                container.style.zIndex = '1000';
                container.style.maxWidth = '90%';
                container.style.maxHeight = '90vh';
                container.style.overflow = 'auto';

                container.appendChild(jsonDisplay);
                container.appendChild(buttonContainer);
                document.body.appendChild(container);

                // 自动选中文本方便用户手动复制
                textarea.select();
            },

            // 收藏本UI更新
            updateFavoriteModeUI() {
                const library = this.getCurrentLibrary();

                // 检查是否有题库
                if (!library || !library.questions || library.questions.length === 0) {
                    document.getElementById('favorite-question-container').innerHTML = '<p>请先导入题库</p>';
                    document.getElementById('favorite-status-info').textContent = '0/0';
                    document.getElementById('favorite-progress').style.width = '0%';
                    return;
                }

                const favoriteMode = library.favoriteMode;
                const favoriteQuestions = library.favoriteQuestions;

                if (!favoriteQuestions || favoriteQuestions.length === 0) {
                    document.getElementById('favorite-question-container').innerHTML = '<p>暂无收藏题目</p>';
                    document.getElementById('favorite-status-info').textContent = '0/0';
                    document.getElementById('favorite-progress').style.width = '0%';
                    return;
                }

                const currentQuestionIndex = favoriteQuestions[favoriteMode.currentIndex];
                const currentQuestion = library.questions[currentQuestionIndex];

                // 更新状态信息
                document.getElementById('favorite-status-info').textContent =
                `${favoriteMode.currentIndex + 1}/${favoriteQuestions.length}`;

                // 更新进度条
                document.getElementById('favorite-progress').style.width =
                `${((favoriteMode.currentIndex + 1) / favoriteQuestions.length) * 100}%`;

                // 更新题目（支持图片）
                const questionElement = document.getElementById('favorite-question');
                questionElement.innerHTML =
                `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">${currentQuestion.类型 === '单选' ? '单选题': '多选题'}</div>
                <span>${library.favoriteMode.currentIndex + 1}. </span>${this.renderQuestionWithImages(currentQuestion)}`;

                // 更新选项（支持图片）
                const optionsContainer = document.getElementById('favorite-options');
                optionsContainer.innerHTML = '';

                const optionLetters = ['A',
                    'B',
                    'C',
                    'D',
                    'E',
                    'F',
                    'G',
                    'H'];
                optionLetters.forEach(letter => {
                    if (currentQuestion[`选项${letter}`] || currentQuestion[`选项${letter}Image`]) {
                        const option = document.createElement('div');
                        option.className = 'option';

                        const optionLetter = document.createElement('span');
                        optionLetter.className = 'option-letter';
                        optionLetter.textContent = letter;

                        const optionText = document.createElement('span');
                        optionText.innerHTML = this.renderOptionWithImages(letter, currentQuestion);

                        option.appendChild(optionLetter);
                        option.appendChild(optionText);

                        // 标记正确答案
                        if (currentQuestion.答案.includes(letter)) {
                            option.classList.add('correct-answer');
                        }

                        optionsContainer.appendChild(option);
                    }
                });

                // 更新答案和解析（支持图片）
                const answerContainer = document.getElementById('favorite-answer-container');
                answerContainer.innerHTML = `<strong>正确答案：</strong>${currentQuestion.答案}`;

                const explanationContainer = document.getElementById('favorite-explanation-container');
                let explanation = this.formatTextWithLineBreaks(currentQuestion.解析) || '暂无解析';
                if (currentQuestion.explanationImage) {
                    explanation += this.renderImage(currentQuestion.explanationImage, 'explanation-image');
                }
                explanationContainer.innerHTML = `<strong>解析：</strong>${explanation}`;

                // 更新跳转输入框
                document.getElementById('favorite-jumpInput').value = favoriteMode.currentIndex + 1;
            },

            renderImage(imageData, className = '') {
                if (!imageData) return '';
                return `<img src="${imageData}" class="${className}" alt="Rendered Image">`;
            },

            // 更新题目渲染方法
            renderQuestionWithImages: function(question) {
                let html = '';

                // 共用题干标识
                if (question.commonStem) {
                    html += `<div class="common-stem" style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-left: 4px solid #2196F3;">
                    <strong>[共用题干]</strong> ${question.commonStem}
                    </div>`;
                }
                // 共用选项标识（只在题干前显示）
                else if (question.commonOptions) {
                    html += `<div style="margin-bottom: 5px; color: #2196F3; font-weight: bold;">[共用选项]</div>`;
                }

                html += question.题干;

                if (question.questionImage) {
                    html += this.renderImage(question.questionImage, 'question-image');
                }

                return html;
            },

            // 更新选项渲染方法
            renderOptionWithImages: function(letter, question) {
                // 如果有共用选项，使用共用选项内容
                const optionText = question.commonOptions ?
                question.commonOptions[letter]:
                (question[`选项${letter}`] || '');

                let html = optionText;

                if (question[`选项${letter}Image`]) {
                    html += this.renderImage(question[`选项${letter}Image`], 'option-image');
                }

                return html;
            },

            // 错题练习模式下的多选题选项切换
            toggleMultiSelectOptionInWrongMode(optionLetter) {
                const library = this.getCurrentLibrary();
                const currentQuestionIndex = library.wrongQuestions[library.wrongMode.currentIndex];

                if (!library.wrongPracticeMode.userAnswers[currentQuestionIndex]) {
                    library.wrongPracticeMode.userAnswers[currentQuestionIndex] = {
                        selected: [optionLetter],
                        isSubmitted: false
                    };
                } else {
                    const userAnswer = library.wrongPracticeMode.userAnswers[currentQuestionIndex];
                    const index = userAnswer.selected.indexOf(optionLetter);

                    if (index === -1) {
                        userAnswer.selected.push(optionLetter);
                    } else {
                        userAnswer.selected.splice(index, 1);
                    }
                }

                this.saveToStorage();
                this.updateWrongModeUI();
            },

            // 在quizApp对象中添加以下属性和方法
            examData: {
                currentExam: null,
                exams: [],
                timer: null,
                timeLeft: 0,
                questionTimer: null,
                // 每题计时器
                questionTimeLeft: 0 // 每题剩余时间
            },

            // 修改 reviewExam 方法
            reviewExam: function(filter = 'all') {
    const exam = this.examData.currentExam;
    if (!exam || !exam.result) return;

    // 强制显示考试详情区域
    document.getElementById('exam-review').classList.remove('hidden');

    const reviewContainer = document.getElementById('exam-review');
    reviewContainer.innerHTML = '';

    // 使用exam.questions而不是exam.result.questions
    const questionsToReview = exam.questions.filter((question, index) => {
        const userAnswer = exam.answers[index];
        if (!userAnswer) return filter === 'wrong'; // 未作答算错题

        const isCorrect = this.isExamAnswerCorrect(question, userAnswer);

        if (filter === 'all') return true;
        if (filter === 'wrong') return !isCorrect;
        if (filter === 'correct') return isCorrect;
        return true;
    });

    if (questionsToReview.length === 0) {
        reviewContainer.innerHTML = `<p>没有${filter === 'all' ? '': filter === 'wrong' ? '错': '正确'}题目</p>`;
        return;
    }

    questionsToReview.forEach((question, filteredIndex) => {
        // 找到原始索引
        const originalIndex = exam.questions.indexOf(question);
        const userAnswer = exam.answers[originalIndex];
        const isCorrect = this.isExamAnswerCorrect(question, userAnswer);

        const reviewItem = document.createElement('div');
        reviewItem.className = `exam-review-item ${isCorrect ? 'exam-review-correct': 'exam-review-wrong'}`;

        // 题目部分
        const questionElement = document.createElement('div');
        questionElement.className = 'question';
        questionElement.innerHTML =
        `<div style="margin-bottom: 5px; color: #666; font-size: 0.9em;">
        ${question.类型 === '单选' ? '单选题': '多选题'} (原题号: ${originalIndex + 1})
        </div>
        <strong>${filteredIndex + 1}. </strong>${this.renderQuestionWithImages(question)}`;

        // 选项部分
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'exam-review-options';
        optionsContainer.style.margin = '10px 0';

        const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        optionLetters.forEach(letter => {
            if (question[`选项${letter}`] || question[`选项${letter}Image`]) {
                const optionDiv = document.createElement('div');
                optionDiv.style.margin = '5px 0';
                optionDiv.style.padding = '5px';

                // 标记正确答案
                if (question.答案.includes(letter)) {
                    optionDiv.style.backgroundColor = '#e8f5e9';
                    optionDiv.style.borderLeft = '3px solid #4CAF50';
                }

                // 标记用户答案
                if (userAnswer) {
                    if (question.类型 === '多选') {
                        if (userAnswer.selected && userAnswer.selected.includes(letter)) {
                            optionDiv.style.borderLeft = '3px solid #2196F3';
                        }
                    } else {
                        if (userAnswer.selected === letter) {
                            optionDiv.style.borderLeft = '3px solid #2196F3';
                        }
                    }
                }

                optionDiv.innerHTML = `<strong>${letter}. </strong>${this.renderOptionWithImages(letter, question)}`;
                optionsContainer.appendChild(optionDiv);
            }
        });

        // 用户答案
        const userAnswerElement = document.createElement('div');
        userAnswerElement.className = 'user-answer';
        const userAnswerText = userAnswer ?
        (question.类型 === '多选' ?
            (userAnswer.selected ? userAnswer.selected.join(', '): '未作答'):
            (userAnswer.selected || '未作答')):
        '未作答';
        userAnswerElement.innerHTML = `<strong>你的答案: </strong>${userAnswerText}`;

        // 正确答案
        const correctAnswerElement = document.createElement('div');
        correctAnswerElement.className = 'correct-answer';
        correctAnswerElement.innerHTML = `<strong>正确答案: </strong>${question.答案}`;

        // 解析
        const explanationElement = document.createElement('div');
        explanationElement.className = 'explanation';
        let explanation = question.解析 || '暂无解析';
        if (question.explanationImage) {
            explanation += this.renderImage(question.explanationImage, 'explanation-image');
        }
        explanationElement.innerHTML = `<strong>解析: </strong>${explanation}`;

        // 组装
        reviewItem.appendChild(questionElement);
        reviewItem.appendChild(optionsContainer);
        reviewItem.appendChild(userAnswerElement);
        reviewItem.appendChild(correctAnswerElement);
        reviewItem.appendChild(explanationElement);

        reviewContainer.appendChild(reviewItem);
    });

    reviewContainer.classList.remove('hidden');
},

            // 初始化考试功能
            initExam: function() {
                // 添加导航按钮点击事件
                document.getElementById('single-choice-count').addEventListener('input',
                    this.validateExamSettings.bind(this));
                document.getElementById('multi-choice-count').addEventListener('input',
                    this.validateExamSettings.bind(this));
                document.getElementById('exam-quantity').addEventListener('input',
                    this.validateExamSettings.bind(this));
                document.getElementById('start-exam-btn').addEventListener('click',
                    this.startExam.bind(this));
                document.getElementById('prev-exam-question').addEventListener('click',
                    this.prevExamQuestion.bind(this));
                document.getElementById('next-exam-question').addEventListener('click',
                    this.nextExamQuestion.bind(this));
                document.getElementById('submit-exam').addEventListener('click',
                    this.submitExam.bind(this));
                document.getElementById('exam-answer-sheet').addEventListener('click',
                    this.showAnswerSheet.bind(this));
                document.getElementById('close-answer-sheet').addEventListener('click',
                    this.hideAnswerSheet.bind(this));
                document.getElementById('review-exam').addEventListener('click', () => {
                        // 默认显示全部题目
                        quizApp.reviewExam('all');
                    });

                // 在initExam方法中添加按钮事件监听
                document.getElementById('show-correct').addEventListener('click',
                    () => {
                        this.reviewExam('correct');
                    });
                document.getElementById('show-wrong').addEventListener('click',
                    () => {
                        this.reviewExam('wrong');
                    });

                document.getElementById('save-exam').addEventListener('click',
                    this.saveExam.bind(this));
                document.getElementById('export-exam').addEventListener('click',
                    this.exportExam.bind(this));
                document.getElementById('new-exam').addEventListener('click',
                    this.newExam.bind(this));
                document.getElementById('export-wrong-answers').addEventListener('click',
                    () => {
                        this.exportWrongAnswersFromExam();
                    });

                // 初始化考试历史UI
                this.updateExamHistoryUI();

                document.getElementById('exit-exam').addEventListener('click',
                    () => {
                        if (confirm('确定要退出考试吗？当前进度将不会保存')) {
                            document.querySelector('.nav-bar').classList.remove('hidden');
                            this.newExam();
                        }
                    });

                // 添加查看考试历史按钮点击事件
                document.getElementById('view-exam-history').addEventListener('click',
                    () => {
                        this.toggleExamHistory();
                    });
            },

            validateExamSettings: function() {
                const totalQuestions = parseInt(document.getElementById('exam-quantity').value) || 0;
                const singleChoiceCount = parseInt(document.getElementById('single-choice-count').value) || 0;
                const multiChoiceCount = parseInt(document.getElementById('multi-choice-count').value) || 0;

                // 如果两种类型题目数量之和大于总题目数量，则调整
                if (singleChoiceCount + multiChoiceCount > totalQuestions && totalQuestions > 0) {
                    if (singleChoiceCount > 0 && multiChoiceCount > 0) {
                        // 按比例分配
                        const ratio = singleChoiceCount / (singleChoiceCount + multiChoiceCount);
                        const adjustedSingle = Math.round(totalQuestions * ratio);
                        const adjustedMulti = totalQuestions - adjustedSingle;

                        document.getElementById('single-choice-count').value = adjustedSingle;
                        document.getElementById('multi-choice-count').value = adjustedMulti;
                    } else if (singleChoiceCount > 0) {
                        document.getElementById('single-choice-count').value = totalQuestions;
                        document.getElementById('multi-choice-count').value = 0;
                    } else if (multiChoiceCount > 0) {
                        document.getElementById('single-choice-count').value = 0;
                        document.getElementById('multi-choice-count').value = totalQuestions;
                    }
                }

                // 如果总题目数量为0，则清空其他输入
                if (totalQuestions === 0) {
                    document.getElementById('single-choice-count').value = '';
                    document.getElementById('multi-choice-count').value = '';
                }
            },

            // 切换考试历史显示
            toggleExamHistory: function() {
                const examHistory = document.getElementById('exam-history');
                examHistory.classList.toggle('hidden');
            },

            // 更新考试历史UI
            updateExamHistoryUI: function() {
                const historyList = document.getElementById('exam-history-list');
                historyList.innerHTML = '';

                // 确保考试按时间倒序排列
                const sortedExams = [...this.examData.exams].sort((a, b) => b.id - a.id);

                if (sortedExams.length === 0) {
                    historyList.innerHTML = '<p>暂无考试历史记录</p>';
                    return;
                }

                sortedExams.forEach((exam) => {
                    // 只显示已完成且有结果的考试
                    if (!exam.result) return;

                    const historyItem = document.createElement('div');
                    historyItem.className = 'exam-history-item';

                    const minutes = Math.floor(exam.result.timeUsed / 60);
                    const seconds = exam.result.timeUsed % 60;
                    const timeUsedStr = `${minutes}:${seconds < 10 ? '0' + seconds: seconds}`;

                    historyItem.innerHTML = `
                    <div class="exam-history-info">
                    <strong>${exam.name}</strong>
                    <div>得分: ${exam.result.achievedScore}/${exam.result.totalScore}</div>
                    <div>用时: ${timeUsedStr}</div>
                    <div>日期: ${new Date(exam.result.endTime).toLocaleString()}</div>
                    </div>
                    <div class="exam-history-actions">
                    <button class="button button-primary view-exam-btn" data-id="${exam.id}">查看</button>
                    <button class="button button-danger delete-exam-btn" data-id="${exam.id}">删除</button>
                    </div>
                    `;

                    historyList.appendChild(historyItem);
                });

                // 重新绑定按钮事件
                document.querySelectorAll('.view-exam-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const examId = parseInt(e.target.getAttribute('data-id'));
                        this.viewExamHistory(examId);
                    });
                });

                document.querySelectorAll('.delete-exam-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const examId = parseInt(e.target.getAttribute('data-id'));
                        this.deleteExamHistory(examId);
                    });
                });
            },

            // 修改viewExamHistory方法
            viewExamHistory: function(examId) {
    const exam = this.examData.exams.find(e => e.id === examId);
    if (!exam || !exam.result) return;

    // 设置当前考试 - 创建新对象避免引用问题
    this.examData.currentExam = JSON.parse(JSON.stringify(exam));

    // 显示考试结果
    document.getElementById('exam-settings').classList.add('hidden');
    document.getElementById('exam-history').classList.add('hidden');
    document.getElementById('exam-results').classList.remove('hidden');

    // 更新结果UI
    document.getElementById('exam-result-title').textContent = exam.name;
    document.getElementById('total-score').textContent = exam.result.totalScore;
    document.getElementById('achieved-score').textContent = exam.result.achievedScore;
    document.getElementById('correct-rate').textContent = `${exam.result.correctRate}%`;

    // 更新单选/多选统计显示
    document.getElementById('single-stats').textContent = 
        `${exam.result.stats.singleCorrect}/${exam.result.singleCount}`;
    document.getElementById('multi-stats').textContent = 
        `${exam.result.stats.multiCorrect}/${exam.result.multiCount}`;

    const minutes = Math.floor(exam.result.timeUsed / 60);
    const seconds = exam.result.timeUsed % 60;
    document.getElementById('time-used').textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

    // 重置考试详情视图
    document.getElementById('exam-review').innerHTML = '';
    document.getElementById('exam-review').classList.add('hidden');
},

            // 删除考试历史
            deleteExamHistory: async function(examId) {
              if (confirm('确定要删除这条考试记录吗？')) {
                  try {
                      const index = this.examData.exams.findIndex(e => e.id === examId);
                      if (index !== -1) {
                          this.examData.exams.splice(index, 1);
            
                          // 保存到IndexedDB
                          await this.saveExamHistory();
            
                          // 重新加载考试历史
                          await this.loadExamHistory();
            
                          // 更新UI
                          this.updateExamHistoryUI();
            
                          // 如果当前查看的是被删除的考试，则返回设置页面
                          if (this.examData.currentExam && this.examData.currentExam.id === examId) {
                              this.newExam();
                          }
            
                          alert('删除成功');
                      }
                  } catch (error) {
                      console.error('删除考试记录失败:', error);
                      alert('删除失败: ' + error.message);
                  }
              }
            },

            // 开始考试
            startExam: function() {
                const library = this.getCurrentLibrary();
                if (!library || library.questions.length === 0) {
                    alert('当前题库为空，无法开始考试');
                    return;
                }

                // 获取考试设置
                const examName = document.getElementById('exam-name').value || '模拟考试';
                const totalQuestions = parseInt(document.getElementById('exam-quantity').value) || 20;
                let singleChoiceCount = parseInt(document.getElementById('single-choice-count').value) || 0;
                let multiChoiceCount = parseInt(document.getElementById('multi-choice-count').value) || 0;
                const singleChoiceScore = parseInt(document.getElementById('single-choice-score').value) || 5;
                const multiChoiceScore = parseInt(document.getElementById('multi-choice-score').value) || 10;
                const singleChoiceTime = parseInt(document.getElementById('single-choice-time').value) || 60;
                const multiChoiceTime = parseInt(document.getElementById('multi-choice-time').value) || 90;
                const examMode = document.getElementById('exam-mode').value || 'normal';

                // 验证题目数量
                if (totalQuestions > library.questions.length) {
                    alert(`题库中只有${library.questions.length}道题目，无法设置${totalQuestions}道题目`);
                    return;
                }

                // 如果两种类型题目数量之和为0，则默认全部为单选题
                if (singleChoiceCount === 0 && multiChoiceCount === 0) {
                    singleChoiceCount = totalQuestions;
                }

                // 分离单选和多选题
                const singleChoiceQuestions = library.questions.filter(q => q.类型 === '单选');
                const multiChoiceQuestions = library.questions.filter(q => q.类型 === '多选');

                // 验证题目数量是否足够
                if (singleChoiceCount > singleChoiceQuestions.length) {
                    alert(`题库中只有${singleChoiceQuestions.length}道单选题，无法设置${singleChoiceCount}道单选题`);
                    return;
                }

                if (multiChoiceCount > multiChoiceQuestions.length) {
                    alert(`题库中只有${multiChoiceQuestions.length}道多选题，无法设置${multiChoiceCount}道多选题`);
                    return;
                }

                // 随机选择题目
                const selectedQuestions = [];

                // 随机选择单选题（如果有）
                if (singleChoiceCount > 0) {
                    const shuffledSingle = [...singleChoiceQuestions].sort(() => 0.5 - Math.random());
                    selectedQuestions.push(...shuffledSingle.slice(0, singleChoiceCount));
                }

                // 随机选择题（如果有）
                if (multiChoiceCount > 0) {
                    const shuffledMulti = [...multiChoiceQuestions].sort(() => 0.5 - Math.random());
                    selectedQuestions.push(...shuffledMulti.slice(0, multiChoiceCount));
                }

                // 打乱题目顺序
                const shuffledExamQuestions = [...selectedQuestions].sort(() => 0.5 - Math.random());

                // 计算总时间（秒）
                const totalTime = (singleChoiceCount * singleChoiceTime) + (multiChoiceCount * multiChoiceTime);

                // 初始化考试数据
                this.examData.currentExam = {
                    id: Date.now(),
                    name: examName,
                    questions: shuffledExamQuestions,
                    answers: {},
                    currentIndex: 0,
                    startTime: new Date(),
                    singleChoiceScore: singleChoiceScore,
                    multiChoiceScore: multiChoiceScore,
                    totalTime: totalTime,
                    timeLeft: totalTime,
                    settings: {
                        totalQuestions: totalQuestions,
                        singleChoiceCount: singleChoiceCount,
                        multiChoiceCount: multiChoiceCount,
                        singleChoiceTime: singleChoiceTime,
                        multiChoiceTime: multiChoiceTime,
                        examMode: examMode
                    },
                    stats: {
                        singleCorrect: 0,
                        singleWrong: 0,
                        multiCorrect: 0,
                        multiWrong: 0
                    }
                };

                // 更新UI
                document.querySelector('.nav-bar').classList.add('hidden');
                document.getElementById('exam-settings').classList.add('hidden');
                document.getElementById('exam-history').classList.add('hidden');
                document.getElementById('exam-in-progress').classList.remove('hidden');

                // 开始计时器
                this.startExamTimer();

                // 显示第一题
                this.showExamQuestion(0);
            },
            exportWrongAnswersFromExam: function() {
                const exam = this.examData.currentExam;
                if (!exam || !exam.result) return;

                // 收集错题
                const wrongQuestions = [];
                exam.questions.forEach((question, index) => {
                    const userAnswer = exam.answers[index];
                    if (!userAnswer) {
                        // 未作答也算错题
                        wrongQuestions.push(question);
                        return;
                    }

                    if (question.类型 === '多选') {
                        const userAnswerStr = userAnswer.selected ? userAnswer.selected.sort().join(''): '';
                        const correctAnswerStr = question.答案.split('').sort().join('');
                        if (userAnswerStr !== correctAnswerStr) {
                            wrongQuestions.push(question);
                        }
                    } else {
                        if (userAnswer.selected !== question.答案) {
                            wrongQuestions.push(question);
                        }
                    }
                });

                if (wrongQuestions.length === 0) {
                    alert('本次考试没有错题');
                    return;
                }

                // 准备导出数据
                const exportData = wrongQuestions.map(question => {
                    const row = {
                        '题干': question.题干,
                        '类型': question.类型,
                        '答案': question.答案,
                        '解析': question.解析 || ''
                    };

                    // 添加选项
                    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                    optionLetters.forEach(letter => {
                        if (question[`选项${letter}`]) {
                            row[`选项${letter}`] = question[`选项${letter}`];
                        }
                        if (question[`选项${letter}Image`]) {
                            row[`选项${letter}Image`] = question[`选项${letter}Image`];
                        }
                    });

                    return row;
                });

                // 创建JSON字符串
                const jsonStr = JSON.stringify({
                    name: `${exam.name}-错题集`,
                    questions: exportData
                }, null, 2);

                // 显示导出选项对话框
                this.showExportOptions(jsonStr, `${exam.name}-错题集`);
            },

            // 显示考试题目
            showExamQuestion: function(index) {
                const exam = this.examData.currentExam;
                if (!exam || index < 0 || index >= exam.questions.length) return;

                // 清除每题计时器
                if (this.examData.questionTimer) {
                    clearInterval(this.examData.questionTimer);
                    this.examData.questionTimer = null;
                }

                exam.currentIndex = index;

                // 更新进度
                document.getElementById('exam-progress').textContent =
                `${index + 1}/${exam.questions.length}`;

                const question = exam.questions[index];

                // 修改 showExamQuestion 方法中的计时器部分
                if (exam.settings.examMode === 'timed') {
                    const questionTime = question.类型 === '多选' ?
                    exam.settings.multiChoiceTime: exam.settings.singleChoiceTime;
                    this.examData.questionTimeLeft = questionTime;

                    // 更新计时器显示
                    this.updateQuestionTimerDisplay();

                    // 在每题计时模式下禁用导航按钮
                    document.getElementById('prev-exam-question').disabled = true;
                    document.getElementById('next-exam-question').disabled = true;

                    // 启动每题计时器
                    this.examData.questionTimer = setInterval(() => {
                        this.examData.questionTimeLeft--;
                        this.updateQuestionTimerDisplay();

                        // 时间到自动下一题
                        if (this.examData.questionTimeLeft <= 0) {
                            // 清除计时器
                            clearInterval(this.examData.questionTimer);
                            this.examData.questionTimer = null;

                            // 标记为未作答
                            if (!exam.answers[index]) {
                                exam.answers[index] = {
                                    selected: '',
                                    isSubmitted: true
                                };

                                // 更新统计
                                if (question.类型 === '多选') {
                                    exam.stats.multiWrong++;
                                } else {
                                    exam.stats.singleWrong++;
                                }
                            }

                            // 如果是最后一题则交卷，否则下一题
                            if (index === exam.questions.length - 1) {
                                this.submitExam();
                            } else {
                                this.nextExamQuestion();
                            }
                        }
                    },
                        1000);
                } else {
                    // 常规模式下正常启用导航
                    document.getElementById('prev-exam-question').disabled = index === 0;
                    document.getElementById('next-exam-question').disabled = index === exam.questions.length - 1;
                    this.examData.disableSwipe = false;
                }

                // 显示题目
                document.getElementById('exam-question').innerHTML =
                `<div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">${
                question.类型 === '单选' ? '单选题': '多选题'
                }</div>
                <span>${index + 1}. </span>${this.renderQuestionWithImages(question)}`;

                // 显示选项或答案输入区域
                const optionsContainer = document.getElementById('exam-options');
                optionsContainer.innerHTML = '';

                if (question.类型 === '填空' || question.类型 === '简答') {
                    // 创建答案输入区域
                    const answerInput = document.createElement(question.类型 === '填空' ? 'input': 'textarea');
                    answerInput.type = question.类型 === '填空' ? 'text': 'textarea';
                    answerInput.placeholder = question.类型 === '填空' ? '请输入答案': '请输入简要回答';
                    answerInput.className = 'form-input';
                    answerInput.style.width = '100%';
                    answerInput.style.marginTop = '10px';

                    // 保存用户输入
                    answerInput.addEventListener('input', () => {
                        if (!exam.answers[index]) {
                            exam.answers[index] = {};
                        }
                        exam.answers[index].selected = answerInput.value;
                        this.updateAnswerSheet();
                    });

                    // 恢复已输入的答案
                    if (exam.answers[index] && exam.answers[index].selected) {
                        answerInput.value = exam.answers[index].selected;
                    }

                    optionsContainer.appendChild(answerInput);
                } else {
                    // 原有选择题逻辑
                    const optionLetters = ['A',
                        'B',
                        'C',
                        'D',
                        'E',
                        'F',
                        'G',
                        'H'];
                    optionLetters.forEach(letter => {
                        if (question[`选项${letter}`] || question[`选项${letter}Image`]) {
                            const option = document.createElement('div');
                            option.className = 'option';

                            const optionLetter = document.createElement('span');
                            optionLetter.className = 'option-letter';
                            optionLetter.textContent = letter;

                            const optionText = document.createElement('span');
                            optionText.innerHTML = this.renderOptionWithImages(letter, question);

                            option.appendChild(optionLetter);
                            option.appendChild(optionText);

                            // 添加点击事件
                            if (question.类型 === '多选') {
                                // 多选题逻辑
                                const userAnswer = exam.answers[index] || {
                                    selected: []
                                };

                                if (userAnswer.selected && userAnswer.selected.includes(letter)) {
                                    option.classList.add('selected-option');
                                }

                                option.addEventListener('click', () => {
                                    this.toggleMultiSelectExamOption(letter);
                                });
                            } else {
                                // 单选题逻辑
                                if (exam.answers[index] && exam.answers[index].selected === letter) {
                                    option.classList.add('selected-option');
                                }

                                option.addEventListener('click', () => {
                                    this.selectExamOption(letter);
                                });
                            }

                            optionsContainer.appendChild(option);
                        }
                    });
                }

                // 更新答题卡按钮状态
                this.updateAnswerSheet();
            },

            updateQuestionTimerDisplay: function() {
                const exam = this.examData.currentExam;
                if (!exam || exam.settings.examMode !== 'timed') return;

                const minutes = Math.floor(this.examData.questionTimeLeft / 60);
                const seconds = this.examData.questionTimeLeft % 60;
                document.getElementById('exam-timer').textContent =
                `本题剩余时间: ${minutes}:${seconds < 10 ? '0' + seconds: seconds}`;
            },

            // 修改 selectExamOption 方法
            selectExamOption: function(letter) {
                const exam = this.examData.currentExam;
                if (!exam) return;

                const index = exam.currentIndex;
                exam.answers[index] = {
                    selected: letter,
                    isCorrect: letter === exam.questions[index].答案,
                    isSubmitted: true
                };

                // 更新UI
                const options = document.getElementById('exam-options').querySelectorAll('.option');
                options.forEach(opt => {
                    opt.classList.remove('selected-option');
                });

                const selectedOption = Array.from(options).find(opt =>
                    opt.querySelector('.option-letter').textContent === letter
                );

                if (selectedOption) {
                    selectedOption.classList.add('selected-option');
                }

                // 在每题计时模式下，选择答案后启用下一题按钮
                if (exam.settings.examMode === 'timed') {
                    document.getElementById('next-exam-question').disabled = false;

                    // 清除计时器
                    if (this.examData.questionTimer) {
                        clearInterval(this.examData.questionTimer);
                        this.examData.questionTimer = null;
                    }
                }

                // 更新答题卡
                this.updateAnswerSheet();
            },

            // 切换多选题选项
            toggleMultiSelectExamOption: function(letter) {
                const exam = this.examData.currentExam;
                if (!exam) return;

                const index = exam.currentIndex;
                if (!exam.answers[index]) {
                    exam.answers[index] = {
                        selected: []
                    };
                }

                const optionIndex = exam.answers[index].selected.indexOf(letter);
                if (optionIndex === -1) {
                    exam.answers[index].selected.push(letter);
                } else {
                    exam.answers[index].selected.splice(optionIndex, 1);
                }

                // 更新UI
                const options = document.getElementById('exam-options').querySelectorAll('.option');
                options.forEach(opt => {
                    const optLetter = opt.querySelector('.option-letter').textContent;
                    if (exam.answers[index].selected.includes(optLetter)) {
                        opt.classList.add('selected-option');
                    } else {
                        opt.classList.remove('selected-option');
                    }
                });

                // 在每题计时模式下，选择答案后启用下一题按钮
                if (exam.settings.examMode === 'timed') {
                    document.getElementById('next-exam-question').disabled = false;
                }

                // 更新答题卡
                this.updateAnswerSheet();
            },

            // 上一题
            prevExamQuestion: function() {
                const exam = this.examData.currentExam;
                if (!exam || exam.currentIndex <= 0) return;

                this.showExamQuestion(exam.currentIndex - 1);
            },

            // 下一题
            nextExamQuestion: function() {
                const exam = this.examData.currentExam;
                if (!exam || exam.currentIndex >= exam.questions.length - 1) return;

                // 在每题计时模式下，重置下一题按钮状态
                if (exam.settings.examMode === 'timed') {
                    document.getElementById('next-exam-question').disabled = true;
                }

                this.showExamQuestion(exam.currentIndex + 1);
            },

            // 开始考试计时器
            startExamTimer: function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                // 清除现有计时器
                if (this.examData.timer) {
                    clearInterval(this.examData.timer);
                }

                // 更新剩余时间显示
                this.updateTimerDisplay();

                // 启动计时器
                this.examData.timer = setInterval(() => {
                    exam.timeLeft--;
                    this.updateTimerDisplay();

                    // 时间到自动交卷
                    if (exam.timeLeft <= 0) {
                        this.submitExam();
                    }
                },
                    1000);
            },

            // 修改 updateTimerDisplay 方法
            updateTimerDisplay: function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                // 在每题计时模式下不显示总剩余时间
                if (exam.settings.examMode === 'timed') {
                    return; // 不更新总时间显示
                }

                const minutes = Math.floor(exam.timeLeft / 60);
                const seconds = exam.timeLeft % 60;
                document.getElementById('exam-timer').textContent =
                `剩余时间: ${minutes}:${seconds < 10 ? '0' + seconds: seconds}`;
            },

            // 修改 showAnswerSheet 方法
            showAnswerSheet: function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                const buttonsContainer = document.getElementById('answer-sheet-buttons');
                buttonsContainer.innerHTML = '';

                exam.questions.forEach((_, index) => {
                    const button = document.createElement('button');
                    button.className = 'answer-sheet-btn';
                    button.textContent = index + 1;

                    // 标记已回答的题目
                    if (exam.answers[index]) {
                        button.classList.add('answered');
                    }

                    // 标记当前题目
                    if (index === exam.currentIndex) {
                        button.classList.add('current');
                    }

                    // 在每题计时模式下禁用所有按钮
                    if (exam.settings.examMode === 'timed') {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                    } else {
                        // 常规模式下添加点击事件
                        button.addEventListener('click', () => {
                            this.showExamQuestion(index);
                            this.hideAnswerSheet();
                        });
                    }

                    buttonsContainer.appendChild(button);
                });

                document.getElementById('answer-sheet-modal').classList.remove('hidden');
            },

            // 隐藏答题卡
            hideAnswerSheet: function() {
                document.getElementById('answer-sheet-modal').classList.add('hidden');
            },

            // 更新答题卡状态
            updateAnswerSheet: function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                const buttons = document.querySelectorAll('.answer-sheet-btn');
                buttons.forEach((button, index) => {
                    // 更新已回答状态
                    if (exam.answers[index]) {
                        button.classList.add('answered');
                    } else {
                        button.classList.remove('answered');
                    }

                    // 更新当前题目状态
                    if (index === exam.currentIndex) {
                        button.classList.add('current');
                    } else {
                        button.classList.remove('current');
                    }
                });
            },

            submitExam: async function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                // 清除计时器
                if (this.examData.timer) {
                    clearInterval(this.examData.timer);
                    this.examData.timer = null;
                }

                // 清除每题计时器
                if (this.examData.questionTimer) {
                    clearInterval(this.examData.questionTimer);
                    this.examData.questionTimer = null;
                }

                // 重置统计
                exam.stats = {
                    singleCorrect: 0,
                    singleWrong: 0,
                    multiCorrect: 0,
                    multiWrong: 0
                };

                // 计算得分
                let correctCount = 0;
                let totalScore = 0;
                let achievedScore = 0;

                exam.questions.forEach((question, index) => {
                    const userAnswer = exam.answers[index];
                    const isMulti = question.类型 === '多选';
                    const questionScore = isMulti ? exam.multiChoiceScore: exam.singleChoiceScore;

                    if (!userAnswer) {
                        // 未作答算错题
                        if (isMulti) {
                            exam.stats.multiWrong++;
                        } else {
                            exam.stats.singleWrong++;
                        }
                        return;
                    }

                    let isCorrect = false;

                    if (isMulti) {
                        const userAnswerStr = userAnswer.selected ? userAnswer.selected.sort().join(''): '';
                        const correctAnswerStr = question.答案.split('').sort().join('');
                        isCorrect = userAnswerStr === correctAnswerStr;
                    } else {
                        isCorrect = userAnswer.selected === question.答案;
                    }

                    // 更新统计
                    if (isMulti) {
                        if (isCorrect) {
                            exam.stats.multiCorrect++;
                        } else {
                            exam.stats.multiWrong++;
                        }
                    } else {
                        if (isCorrect) {
                            exam.stats.singleCorrect++;
                        } else {
                            exam.stats.singleWrong++;
                        }
                    }

                    if (isCorrect) {
                        correctCount++;
                        achievedScore += questionScore;
                    }

                    totalScore += questionScore;
                });

                const correctRate = Math.round((correctCount / exam.questions.length) * 100);

                // 计算用时
                const endTime = new Date();
                const timeUsed = Math.floor((endTime - exam.startTime) / 1000);

                // 保存考试结果
                exam.result = {
                      correctCount: correctCount,
                      totalQuestions: exam.questions.length,
                      singleCount: exam.settings.singleChoiceCount,
                      multiCount: exam.settings.multiChoiceCount,
                      achievedScore: achievedScore,
                      totalScore: totalScore,
                      correctRate: correctRate,
                      timeUsed: timeUsed,
                      endTime: endTime,
                      stats: exam.stats,
                      questions: exam.questions, // 确保题目数据被保存
                      answers: exam.answers // 确保答案数据被保存
                  };
                try {
                    // 确保考试有ID
                    if (!exam.id) {
                        exam.id = Date.now();
                    }

                    // 检查是否已存在相同ID的考试
                    const existingIndex = this.examData.exams.findIndex(e => e.id === exam.id);
                    if (existingIndex === -1) {
                        this.examData.exams.unshift(exam); // 添加到开头
                    } else {
                        this.examData.exams[existingIndex] = exam;
                    }

                    // 保存到存储
                    await this.saveExamHistory();

                    // 更新UI显示结果
                    document.querySelector('.nav-bar').classList.remove('hidden');
                    document.getElementById('exam-in-progress').classList.add('hidden');
                    document.getElementById('exam-results').classList.remove('hidden');

                    document.getElementById('exam-result-title').textContent = exam.name;
                    document.getElementById('total-score').textContent = totalScore;
                    document.getElementById('achieved-score').textContent = achievedScore;
                    document.getElementById('correct-rate').textContent = `${correctRate}%`;

                    // 更新详细统计
                    const singleTotal = exam.stats.singleCorrect + exam.stats.singleWrong;
                    const multiTotal = exam.stats.multiCorrect + exam.stats.multiWrong;
                    document.getElementById('single-stats').textContent =
                    `${exam.stats.singleCorrect}/${singleTotal}`;
                    document.getElementById('multi-stats').textContent =
                    `${exam.stats.multiCorrect}/${multiTotal}`;

                    const minutes = Math.floor(timeUsed / 60);
                    const seconds = timeUsed % 60;
                    document.getElementById('time-used').textContent = `${minutes}:${seconds < 10 ? '0' + seconds: seconds}`;

                    // 更新历史列表
                    this.updateExamHistoryUI();
                } catch (error) {
                    console.error('保存考试历史失败:', error);
                    alert('保存考试结果失败，请重试: ' + error.message);
                }
            },

            // 查看考试详情
            reviewExam: function(filter = 'all') {
              const exam = this.examData.currentExam;
              if (!exam || !exam.result) return;
            
              // 强制显示考试详情区域
              document.getElementById('exam-review').classList.remove('hidden');
            
              const reviewContainer = document.getElementById('exam-review');
              reviewContainer.innerHTML = '';
            
              // 使用exam.questions而不是exam.result.questions
              const questionsToReview = exam.questions.filter((question, index) => {
                  const userAnswer = exam.answers[index];
                  if (!userAnswer) return filter === 'wrong'; // 未作答算错题
            
                  const isCorrect = this.isExamAnswerCorrect(question, userAnswer);
            
                  if (filter === 'all') return true;
                  if (filter === 'wrong') return !isCorrect;
                  if (filter === 'correct') return isCorrect;
                  return true;
              });

                if (questionsToReview.length === 0) {
                    reviewContainer.innerHTML = `<p>没有${filter === 'all' ? '': filter === 'wrong' ? '错': '正确'}题目</p>`;
                    return;
                }

                questionsToReview.forEach((question, filteredIndex) => {
                    // 找到原始索引
                    const originalIndex = exam.questions.indexOf(question);
                    const userAnswer = exam.answers[originalIndex];
                    const isCorrect = this.isExamAnswerCorrect(question, userAnswer);

                    const reviewItem = document.createElement('div');
                    reviewItem.className = `exam-review-item ${isCorrect ? 'exam-review-correct': 'exam-review-wrong'}`;

                    // 题目部分
                    const questionElement = document.createElement('div');
                    questionElement.className = 'question';
                    questionElement.innerHTML =
                    `<div style="margin-bottom: 5px; color: #666; font-size: 0.9em;">
                    ${question.类型 === '单选' ? '单选题': '多选题'} (原题号: ${originalIndex + 1})
                    </div>
                    <strong>${filteredIndex + 1}. </strong>${this.renderQuestionWithImages(question)}`;

                    // 选项部分
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'exam-review-options';
                    optionsContainer.style.margin = '10px 0';

                    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                    optionLetters.forEach(letter => {
                        if (question[`选项${letter}`] || question[`选项${letter}Image`]) {
                            const optionDiv = document.createElement('div');
                            optionDiv.style.margin = '5px 0';
                            optionDiv.style.padding = '5px';

                            // 标记正确答案
                            if (question.答案.includes(letter)) {
                                optionDiv.style.backgroundColor = '#e8f5e9';
                                optionDiv.style.borderLeft = '3px solid #4CAF50';
                            }

                            // 标记用户答案
                            if (userAnswer) {
                                if (question.类型 === '多选') {
                                    if (userAnswer.selected && userAnswer.selected.includes(letter)) {
                                        optionDiv.style.borderLeft = '3px solid #2196F3';
                                    }
                                } else {
                                    if (userAnswer.selected === letter) {
                                        optionDiv.style.borderLeft = '3px solid #2196F3';
                                    }
                                }
                            }

                            optionDiv.innerHTML = `<strong>${letter}. </strong>${this.renderOptionWithImages(letter, question)}`;
                            optionsContainer.appendChild(optionDiv);
                        }
                    });

                    // 用户答案
                    const userAnswerElement = document.createElement('div');
                    userAnswerElement.className = 'user-answer';
                    const userAnswerText = userAnswer ?
                    (question.类型 === '多选' ?
                        (userAnswer.selected ? userAnswer.selected.join(', '): '未作答'):
                        (userAnswer.selected || '未作答')):
                    '未作答';
                    userAnswerElement.innerHTML = `<strong>你的答案: </strong>${userAnswerText}`;

                    // 正确答案
                    const correctAnswerElement = document.createElement('div');
                    correctAnswerElement.className = 'correct-answer';
                    correctAnswerElement.innerHTML = `<strong>正确答案: </strong>${question.答案}`;

                    // 解析
                    const explanationElement = document.createElement('div');
                    explanationElement.className = 'explanation';
                    let explanation = question.解析 || '暂无解析';
                    if (question.explanationImage) {
                        explanation += this.renderImage(question.explanationImage, 'explanation-image');
                    }
                    explanationElement.innerHTML = `<strong>解析: </strong>${explanation}`;

                    // 组装
                    reviewItem.appendChild(questionElement);
                    reviewItem.appendChild(optionsContainer);
                    reviewItem.appendChild(userAnswerElement);
                    reviewItem.appendChild(correctAnswerElement);
                    reviewItem.appendChild(explanationElement);

                    reviewContainer.appendChild(reviewItem);
                });

                reviewContainer.classList.remove('hidden');
            },
            // 判断考试答案是否正确
            isExamAnswerCorrect: function(question,
                userAnswer) {
                if (!userAnswer) return false;

                if (question.类型 === '多选') {
                    const userAnswerStr = userAnswer.selected.sort().join('');
                    const correctAnswerStr = question.答案.split('').sort().join('');
                    return userAnswerStr === correctAnswerStr;
                } else {
                    return userAnswer.selected === question.答案;
                }
            },

            saveExam: async function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                try {
                    // 确保考试有唯一ID
                    if (!exam.id) {
                        exam.id = Date.now();
                    }

                    // 确保数据可序列化
                    const examToSave = JSON.parse(JSON.stringify(exam));
                    this.examData.currentExam = examToSave;

                    await this.saveExamHistory();

                    // 更新历史列表
                    this.updateExamHistoryUI();

                    alert('考试已保存');
                } catch (error) {
                    console.error('保存考试失败:', error);
                    alert('保存考试失败: ' + (error.message || error));
                }
            },

            async saveExamHistory() {
              return new Promise((resolve, reject) => {
                  if (!this.db) {
                      reject('Database not initialized');
                      return;
                  }
            
                  const transaction = this.db.transaction(['examHistory'], 'readwrite');
                  transaction.onerror = (event) => {
                      console.error('事务错误:', event.target.error);
                      reject(event.target.error);
                  };
            
                  const store = transaction.objectStore('examHistory');
            
                  // 先清空现有数据
                  const clearRequest = store.clear();
            
                  clearRequest.onsuccess = () => {
                      // 保存所有考试
                      let savedCount = 0;
                      let errorOccurred = false;
            
                      this.examData.exams.forEach(exam => {
                          if (errorOccurred) return;
            
                          // 确保考试有ID
                          if (!exam.id) {
                              exam.id = Date.now();
                          }
            
                          const request = store.put(exam);
            
                          request.onsuccess = () => {
                              savedCount++;
                              if (savedCount === this.examData.exams.length) {
                                  resolve();
                              }
                          };
            
                          request.onerror = (event) => {
                              console.error('保存考试失败:', event.target.error);
                              errorOccurred = true;
                              reject(event.target.error);
                          };
                      });
                  };
            
                  clearRequest.onerror = (event) => {
                      console.error('清空考试历史失败:', event.target.error);
                      reject(event.target.error);
                  };
              });
            },
            
            // 从IndexedDB加载考试历史
            async loadExamHistory() {
                return new Promise((resolve,
                    reject) => {
                    if (!this.db) {
                        reject('Database not initialized');
                        return;
                    }

                    const transaction = this.db.transaction(['examHistory'], 'readonly');
                    const store = transaction.objectStore('examHistory');
                    const request = store.getAll();

                    request.onsuccess = (event) => {
                        // 确保考试按时间倒序排列
                        this.examData.exams = (event.target.result || []).sort((a, b) => b.id - a.id);
                        resolve(this.examData.exams);
                    };

                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            },


            // 导出考试
            exportExam: function() {
                const exam = this.examData.currentExam;
                if (!exam) return;

                // 准备导出数据
                const exportData = {
                    examName: exam.name,
                    settings: exam.settings,
                    questions: exam.questions.map(q => {
                        const questionData = {
                            题干: q.题干,
                            类型: q.类型,
                            答案: q.答案,
                            解析: q.解析 || ''
                        };

                        // 添加选项
                        const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                        optionLetters.forEach(letter => {
                            if (q[`选项${letter}`]) {
                                questionData[`选项${letter}`] = q[`选项${letter}`];
                            }
                            if (q[`选项${letter}Image`]) {
                                questionData[`选项${letter}Image`] = q[`选项${letter}Image`];
                            }
                        });

                        // 添加题目图片和解析图片
                        if (q.questionImage) {
                            questionData['questionImage'] = q.questionImage;
                        }
                        if (q.explanationImage) {
                            questionData['explanationImage'] = q.explanationImage;
                        }

                        return questionData;
                    }),
                    result: exam.result
                };

                // 创建JSON字符串
                const jsonStr = JSON.stringify(exportData,
                    null,
                    2);

                // 显示导出选项对话框
                this.showExportOptions(jsonStr,
                    exam.name || '模拟考试');
            },

            showExportOptions: function(jsonStr,
                examName) {
                // 创建对话框容器
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '50%';
                container.style.left = '50%';
                container.style.transform = 'translate(-50%, -50%)';
                container.style.backgroundColor = 'white';
                container.style.padding = '20px';
                container.style.borderRadius = '5px';
                container.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                container.style.zIndex = '1000';
                container.style.maxWidth = '90%';
                container.style.maxHeight = '90vh';
                container.style.overflow = 'auto';
                container.style.textAlign = 'center';

                // 添加标题
                const title = document.createElement('h3');
                title.textContent = '导出选项';
                title.style.marginBottom = '15px';
                container.appendChild(title);

                // 创建JSON显示区域
                const jsonDisplay = document.createElement('pre');
                jsonDisplay.style.whiteSpace = 'pre-wrap';
                jsonDisplay.style.padding = '10px';
                jsonDisplay.style.backgroundColor = '#f5f5f5';
                jsonDisplay.style.border = '1px solid #ddd';
                jsonDisplay.style.maxHeight = '300px';
                jsonDisplay.style.overflow = 'auto';
                jsonDisplay.textContent = jsonStr;
                container.appendChild(jsonDisplay);

                // 创建按钮容器
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.flexDirection = 'column';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.marginTop = '15px';

                // 创建下载JSON按钮
                const downloadButton = document.createElement('button');
                downloadButton.textContent = '下载JSON文件';
                downloadButton.className = 'button button-primary';
                downloadButton.addEventListener('click',
                    () => {
                        const blob = new Blob([jsonStr], {
                            type: 'application/json'
                        });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${examName || '模拟考试'}.json`;
                        link.click();
                        setTimeout(() => URL.revokeObjectURL(url), 100);
                        document.body.removeChild(container);
                    });
                buttonContainer.appendChild(downloadButton);

                // 创建复制JSON按钮
                const copyButton = document.createElement('button');
                copyButton.textContent = '一键复制JSON';
                copyButton.className = 'button button-success';
                copyButton.addEventListener('click',
                    () => {
                        const textarea = document.createElement('textarea');
                        textarea.value = jsonStr;
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-9999px';
                        textarea.style.top = '-9999px';
                        document.body.appendChild(textarea);
                        textarea.select();

                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                copyButton.textContent = '复制成功!';
                                copyButton.className = 'button button-success';
                                setTimeout(() => {
                                    copyButton.textContent = '一键复制JSON';
                                    copyButton.className = 'button button-success';
                                }, 2000);
                            } else {
                                alert('复制失败，请手动选择文本后按Ctrl+C');
                            }
                        } catch (err) {
                            alert('复制失败，请手动选择文本后按Ctrl+C');
                        } finally {
                            document.body.removeChild(textarea);
                        }
                    });
                buttonContainer.appendChild(copyButton);

                // 创建关闭按钮
                const closeButton = document.createElement('button');
                closeButton.textContent = '关闭';
                closeButton.className = 'button button-danger';
                closeButton.addEventListener('click',
                    () => {
                        document.body.removeChild(container);
                    });
                buttonContainer.appendChild(closeButton);

                container.appendChild(buttonContainer);
                document.body.appendChild(container);
            },

            // 开始新考试
            newExam: function() {
                // 清除计时器
                if (this.examData.timer) {
                    clearInterval(this.examData.timer);
                    this.examData.timer = null;
                }

                this.examData.currentExam = null;

                // 重置所有考试相关UI
                document.querySelector('.nav-bar').classList.remove('hidden');
                document.getElementById('exam-in-progress').classList.add('hidden');
                document.getElementById('exam-results').classList.add('hidden');
                document.getElementById('exam-settings').classList.remove('hidden');
                document.getElementById('exam-review').classList.add('hidden');
                document.getElementById('exam-history').classList.add('hidden');
                document.getElementById('exam-review-controls').classList.add('hidden');


                // 重置考试设置表单
                document.getElementById('exam-name').value = '';
                document.getElementById('exam-quantity').value = '20';
                document.getElementById('single-choice-count').value = '10';
                document.getElementById('multi-choice-count').value = '10';
                document.getElementById('question-score').value = '5';
                document.getElementById('question-time').value = '60';
            },

        };

        // 显示打赏模态框
        function showDonationModal() {
            document.getElementById('donation-modal').classList.remove('hidden');
        }

        // 隐藏打赏模态框
        function hideDonationModal() {
            document.getElementById('donation-modal').classList.add('hidden');
        }

        // 在quizApp对象外部添加全局函数
        function toggleActionButtons(pageType) {
            const buttonsId = `${pageType}-action-buttons`;
            const buttons = document.getElementById(buttonsId);

            // 隐藏所有其他按钮组
            document.querySelectorAll('.action-buttons.hidden-buttons').forEach(btnGroup => {
                if (btnGroup.id !== buttonsId) {
                    btnGroup.classList.add('hidden-buttons');
                }
            });

            // 切换当前按钮组的显示状态
            buttons.classList.toggle('hidden-buttons');

            // 点击页面其他区域关闭按钮组
            if (!buttons.classList.contains('hidden-buttons')) {
                const closeHandler = (e) => {
                    if (!buttons.contains(e.target) && !e.target.classList.contains('menu-button')) {
                        buttons.classList.add('hidden-buttons');
                        document.removeEventListener('click', closeHandler);
                    }
                };

                // 延迟添加事件监听，避免立即触发
                setTimeout(() => {
                    document.addEventListener('click', closeHandler);
                }, 100);
            }
        }

        // 修改全局函数
        function switchPage(pageId, clickedElement) {
            // 隐藏所有按钮组
            document.querySelectorAll('.action-buttons.hidden-buttons').forEach(btnGroup => {
                btnGroup.classList.add('hidden-buttons');
            });

            // 隐藏所有菜单按钮
            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.style.display = 'none';
            });

            // 显示当前页面的菜单按钮
            if (pageId === 'practice-page') {
                document.getElementById('practice-menu-button').style.display = 'flex';
            } else if (pageId === 'back-page') {
                document.getElementById('back-menu-button').style.display = 'flex';
            } else if (pageId === 'wrong-page') {
                document.getElementById('wrong-menu-button').style.display = 'flex';
            } else if (pageId === 'favorite-page') {
                document.getElementById('favorite-menu-button').style.display = 'flex';
            }

            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 显示目标页面
            document.getElementById(pageId).classList.add('active');

            // 更新导航按钮状态（如果是从导航栏点击的）
            if (clickedElement) {
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.classList.remove('active');
                });
                clickedElement.classList.add('active');
            }

            // 检查是否有题库
            const library = quizApp.getCurrentLibrary();
            if (!library || !library.questions || library.questions.length === 0) {
                // 如果没有题库或题目，显示提示信息
                if (pageId === 'practice-page') {
                    document.getElementById('question-container').innerHTML = '<p>请先导入题库</p>';
                } else if (pageId === 'back-page') {
                    document.getElementById('back-question-container').innerHTML = '<p>请先导入题库</p>';
                } else if (pageId === 'wrong-page') {
                    document.getElementById('wrong-question-container').innerHTML = '<p>暂无错题</p>';
                } else if (pageId === 'favorite-page') {
                    document.getElementById('favorite-question-container').innerHTML = '<p>暂无收藏题目</p>';
                }
                return;
            }

            // 根据页面ID更新UI
            switch (pageId) {
                case 'practice-page':
                    quizApp.updatePracticeModeUI(false);
                    break;
                case 'back-page':
                    quizApp.updateBackModeUI();
                    break;
                case 'wrong-page':
                    quizApp.updateWrongModeUI();
                    break;
                case 'favorite-page':
                    quizApp.updateFavoriteModeUI();
                    break;
                case 'exam-page':
                    // 确保考试设置页面显示
                    document.getElementById('exam-settings').classList.remove('hidden');
                    document.getElementById('exam-in-progress').classList.add('hidden');
                    document.getElementById('exam-results').classList.add('hidden');
                    document.getElementById('exam-history').classList.add('hidden');
                    break;
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            quizApp.init();
        });
    </script>
</body>
</html>